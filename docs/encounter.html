<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 4 Modeling Encounter Rate | Best Practices for Using eBird Data</title>
  <meta name="description" content="Best practices for using eBird data to estimate species distributions" />
  <meta name="generator" content="bookdown 0.19 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 4 Modeling Encounter Rate | Best Practices for Using eBird Data" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="Best practices for using eBird data to estimate species distributions" />
  <meta name="github-repo" content="cornelllabofornithology/ebird-good-practices" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 4 Modeling Encounter Rate | Best Practices for Using eBird Data" />
  
  <meta name="twitter:description" content="Best practices for using eBird data to estimate species distributions" />
  

<meta name="author" content="Matthew Strimas-Mackey, Wesley M. Hochachka, Viviana Ruiz-Gutierrez, Orin J. Robinson, Eliot T. Miller, Tom Auer, Steve Kelling, Daniel Fink, Alison Johnston" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="covariates.html"/>
<link rel="next" href="occupancy.html"/>
<script src="libs/header-attrs-2.2/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-135911366-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-135911366-1');
</script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">eBird Best Practices</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome</a></li>
<li class="chapter" data-level="1" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>1</b> Introduction and Setup</a>
<ul>
<li class="chapter" data-level="1.1" data-path="intro.html"><a href="intro.html#intro-intro"><i class="fa fa-check"></i><b>1.1</b> Introduction</a></li>
<li class="chapter" data-level="1.2" data-path="intro.html"><a href="intro.html#intro-pre"><i class="fa fa-check"></i><b>1.2</b> Prerequisites</a></li>
<li class="chapter" data-level="1.3" data-path="intro.html"><a href="intro.html#intro-setup"><i class="fa fa-check"></i><b>1.3</b> Setup</a>
<ul>
<li class="chapter" data-level="1.3.1" data-path="intro.html"><a href="intro.html#intro-setup-data"><i class="fa fa-check"></i><b>1.3.1</b> Data package</a></li>
<li class="chapter" data-level="1.3.2" data-path="intro.html"><a href="intro.html#intro-setup-software"><i class="fa fa-check"></i><b>1.3.2</b> Software</a></li>
<li class="chapter" data-level="1.3.3" data-path="intro.html"><a href="intro.html#intro-setup-packages"><i class="fa fa-check"></i><b>1.3.3</b> R packages</a></li>
<li class="chapter" data-level="1.3.4" data-path="intro.html"><a href="intro.html#intro-setup-tidyverse"><i class="fa fa-check"></i><b>1.3.4</b> Tidyverse</a></li>
<li class="chapter" data-level="1.3.5" data-path="intro.html"><a href="intro.html#intro-setup-ebird"><i class="fa fa-check"></i><b>1.3.5</b> Getting eBird data access</a></li>
<li class="chapter" data-level="1.3.6" data-path="intro.html"><a href="intro.html#intro-setup-gis"><i class="fa fa-check"></i><b>1.3.6</b> GIS data</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="ebird.html"><a href="ebird.html"><i class="fa fa-check"></i><b>2</b> eBird Data</a>
<ul>
<li class="chapter" data-level="2.1" data-path="ebird.html"><a href="ebird.html#ebird-intro"><i class="fa fa-check"></i><b>2.1</b> Introduction</a>
<ul>
<li class="chapter" data-level="2.1.1" data-path="ebird.html"><a href="ebird.html#ebird-intro-tax"><i class="fa fa-check"></i><b>2.1.1</b> eBird taxonomy</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="ebird.html"><a href="ebird.html#ebird-extract"><i class="fa fa-check"></i><b>2.2</b> Data extraction with <code>auk</code></a></li>
<li class="chapter" data-level="2.3" data-path="ebird.html"><a href="ebird.html#ebird-zf"><i class="fa fa-check"></i><b>2.3</b> Importing and zero-filling</a></li>
<li class="chapter" data-level="2.4" data-path="ebird.html"><a href="ebird.html#ebird-detect"><i class="fa fa-check"></i><b>2.4</b> Accounting for variation in detectability</a></li>
<li class="chapter" data-level="2.5" data-path="ebird.html"><a href="ebird.html#ebird-explore"><i class="fa fa-check"></i><b>2.5</b> Exploratory analysis and visualization</a>
<ul>
<li class="chapter" data-level="2.5.1" data-path="ebird.html"><a href="ebird.html#ebird-explore-time"><i class="fa fa-check"></i><b>2.5.1</b> Time of day</a></li>
<li class="chapter" data-level="2.5.2" data-path="ebird.html"><a href="ebird.html#ebird-explore-duration"><i class="fa fa-check"></i><b>2.5.2</b> Checklist duration</a></li>
<li class="chapter" data-level="2.5.3" data-path="ebird.html"><a href="ebird.html#ebird-explore-distance"><i class="fa fa-check"></i><b>2.5.3</b> Distance traveled</a></li>
<li class="chapter" data-level="2.5.4" data-path="ebird.html"><a href="ebird.html#number-of-observers-ebird-explore-observers"><i class="fa fa-check"></i><b>2.5.4</b> Number of observers {#ebird-explore-observers,}</a></li>
</ul></li>
<li class="chapter" data-level="2.6" data-path="ebird.html"><a href="ebird.html#ebird-size"><i class="fa fa-check"></i><b>2.6</b> EBD file size issues</a>
<ul>
<li class="chapter" data-level="2.6.1" data-path="ebird.html"><a href="ebird.html#ebird-size-custom"><i class="fa fa-check"></i><b>2.6.1</b> Custom downloads</a></li>
<li class="chapter" data-level="2.6.2" data-path="ebird.html"><a href="ebird.html#ebird-size-strict"><i class="fa fa-check"></i><b>2.6.2</b> Stricter filtering</a></li>
<li class="chapter" data-level="2.6.3" data-path="ebird.html"><a href="ebird.html#ebird-size-columns"><i class="fa fa-check"></i><b>2.6.3</b> Removing columns</a></li>
<li class="chapter" data-level="2.6.4" data-path="ebird.html"><a href="ebird.html#ebird-size-split"><i class="fa fa-check"></i><b>2.6.4</b> Splitting by species</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="covariates.html"><a href="covariates.html"><i class="fa fa-check"></i><b>3</b> Habitat Covariates</a>
<ul>
<li class="chapter" data-level="3.1" data-path="covariates.html"><a href="covariates.html#covariates-intro"><i class="fa fa-check"></i><b>3.1</b> Introduction</a></li>
<li class="chapter" data-level="3.2" data-path="covariates.html"><a href="covariates.html#covariates-dl"><i class="fa fa-check"></i><b>3.2</b> Downloading MODIS data</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="covariates.html"><a href="covariates.html#covariates-dl-setup"><i class="fa fa-check"></i><b>3.2.1</b> <code>MODIS</code> setup</a></li>
<li class="chapter" data-level="3.2.2" data-path="covariates.html"><a href="covariates.html#covariates-dl-r"><i class="fa fa-check"></i><b>3.2.2</b> Download using R</a></li>
<li class="chapter" data-level="3.2.3" data-path="covariates.html"><a href="covariates.html#covariates-dl-trouble"><i class="fa fa-check"></i><b>3.2.3</b> Troubleshooting</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="covariates.html"><a href="covariates.html#covariates-lsm"><i class="fa fa-check"></i><b>3.3</b> Landscape metrics</a></li>
<li class="chapter" data-level="3.4" data-path="covariates.html"><a href="covariates.html#covariates-prediction"><i class="fa fa-check"></i><b>3.4</b> Prediction surface</a></li>
<li class="chapter" data-level="3.5" data-path="covariates.html"><a href="covariates.html#covariates-elevation"><i class="fa fa-check"></i><b>3.5</b> Elevation</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="encounter.html"><a href="encounter.html"><i class="fa fa-check"></i><b>4</b> Modeling Encounter Rate</a>
<ul>
<li class="chapter" data-level="4.1" data-path="encounter.html"><a href="encounter.html#encouter-intro"><i class="fa fa-check"></i><b>4.1</b> Introduction</a></li>
<li class="chapter" data-level="4.2" data-path="encounter.html"><a href="encounter.html#encounter-data"><i class="fa fa-check"></i><b>4.2</b> Data preparation</a></li>
<li class="chapter" data-level="4.3" data-path="encounter.html"><a href="encounter.html#encounter-sss"><i class="fa fa-check"></i><b>4.3</b> Spatiotemporal subsampling</a></li>
<li class="chapter" data-level="4.4" data-path="encounter.html"><a href="encounter.html#encounter-rf"><i class="fa fa-check"></i><b>4.4</b> Random forests</a>
<ul>
<li class="chapter" data-level="4.4.1" data-path="encounter.html"><a href="encounter.html#encounter-rf-cal"><i class="fa fa-check"></i><b>4.4.1</b> Calibration</a></li>
<li class="chapter" data-level="4.4.2" data-path="encounter.html"><a href="encounter.html#encounter-rf-assess"><i class="fa fa-check"></i><b>4.4.2</b> Assessment</a></li>
</ul></li>
<li class="chapter" data-level="4.5" data-path="encounter.html"><a href="encounter.html#encounter-habitat"><i class="fa fa-check"></i><b>4.5</b> Habitat associations</a>
<ul>
<li class="chapter" data-level="4.5.1" data-path="encounter.html"><a href="encounter.html#encounter-habitat-pi"><i class="fa fa-check"></i><b>4.5.1</b> Predictor importance</a></li>
<li class="chapter" data-level="4.5.2" data-path="encounter.html"><a href="encounter.html#encounter-habitat-pd"><i class="fa fa-check"></i><b>4.5.2</b> Partial dependence</a></li>
</ul></li>
<li class="chapter" data-level="4.6" data-path="encounter.html"><a href="encounter.html#encounter-predict"><i class="fa fa-check"></i><b>4.6</b> Prediction</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="occupancy.html"><a href="occupancy.html"><i class="fa fa-check"></i><b>5</b> Modeling Occupancy</a>
<ul>
<li class="chapter" data-level="5.1" data-path="occupancy.html"><a href="occupancy.html#occupancy-intro"><i class="fa fa-check"></i><b>5.1</b> Introduction</a></li>
<li class="chapter" data-level="5.2" data-path="occupancy.html"><a href="occupancy.html#occupancy-data"><i class="fa fa-check"></i><b>5.2</b> Data preparation</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="occupancy.html"><a href="occupancy.html#occupancy-data-sites"><i class="fa fa-check"></i><b>5.2.1</b> Data formatting</a></li>
<li class="chapter" data-level="5.2.2" data-path="occupancy.html"><a href="occupancy.html#encounter-data-sss"><i class="fa fa-check"></i><b>5.2.2</b> Spatial subsampling</a></li>
<li class="chapter" data-level="5.2.3" data-path="occupancy.html"><a href="occupancy.html#encounter-data-unmarked"><i class="fa fa-check"></i><b>5.2.3</b> <code>unmarked</code> object</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="occupancy.html"><a href="occupancy.html#occupancy-model"><i class="fa fa-check"></i><b>5.3</b> Occupancy modeling</a>
<ul>
<li class="chapter" data-level="5.3.1" data-path="occupancy.html"><a href="occupancy.html#occupancy-model-assess"><i class="fa fa-check"></i><b>5.3.1</b> Assessment</a></li>
<li class="chapter" data-level="5.3.2" data-path="occupancy.html"><a href="occupancy.html#occupancy-model-select"><i class="fa fa-check"></i><b>5.3.2</b> Model selection</a></li>
<li class="chapter" data-level="5.3.3" data-path="occupancy.html"><a href="occupancy.html#occupancy-model-detection"><i class="fa fa-check"></i><b>5.3.3</b> Exploring the effects of covariates on detection probability</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="occupancy.html"><a href="occupancy.html#occupancy-predict"><i class="fa fa-check"></i><b>5.4</b> Prediction</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="abundance.html"><a href="abundance.html"><i class="fa fa-check"></i><b>6</b> Modeling Relative Abundance</a>
<ul>
<li class="chapter" data-level="6.1" data-path="abundance.html"><a href="abundance.html#abundance-intro"><i class="fa fa-check"></i><b>6.1</b> Introduction</a></li>
<li class="chapter" data-level="6.2" data-path="abundance.html"><a href="abundance.html#abundance-data"><i class="fa fa-check"></i><b>6.2</b> Data preparation</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="abundance.html"><a href="abundance.html#abundance-data-sss"><i class="fa fa-check"></i><b>6.2.1</b> Spatiotemporal subsampling</a></li>
<li class="chapter" data-level="6.2.2" data-path="abundance.html"><a href="abundance.html#abundance-data-tt"><i class="fa fa-check"></i><b>6.2.2</b> Test-train split</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="abundance.html"><a href="abundance.html#abundance-explore"><i class="fa fa-check"></i><b>6.3</b> Exploratory data analysis</a></li>
<li class="chapter" data-level="6.4" data-path="abundance.html"><a href="abundance.html#abundance-model"><i class="fa fa-check"></i><b>6.4</b> Abundance models</a></li>
<li class="chapter" data-level="6.5" data-path="abundance.html"><a href="abundance.html#abundance-assess"><i class="fa fa-check"></i><b>6.5</b> Asssessment</a>
<ul>
<li class="chapter" data-level="6.5.1" data-path="abundance.html"><a href="abundance.html#abundance-assess-rank"><i class="fa fa-check"></i><b>6.5.1</b> Predictive performance: Ranking</a></li>
<li class="chapter" data-level="6.5.2" data-path="abundance.html"><a href="abundance.html#abundance-assess-mag"><i class="fa fa-check"></i><b>6.5.2</b> Predictive performance: Magnitude</a></li>
<li class="chapter" data-level="6.5.3" data-path="abundance.html"><a href="abundance.html#abundance-assess-cov"><i class="fa fa-check"></i><b>6.5.3</b> Assessing covariate effects</a></li>
</ul></li>
<li class="chapter" data-level="6.6" data-path="abundance.html"><a href="abundance.html#abundance-predict"><i class="fa fa-check"></i><b>6.6</b> Prediction</a></li>
<li class="chapter" data-level="6.7" data-path="abundance.html"><a href="abundance.html#abundance-final"><i class="fa fa-check"></i><b>6.7</b> Final thoughts</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Best Practices for Using eBird Data</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="encounter" class="section level1" number="4">
<h1><span class="header-section-number">Chapter 4</span> Modeling Encounter Rate</h1>
<div id="encouter-intro" class="section level2" number="4.1">
<h2><span class="header-section-number">4.1</span> Introduction</h2>
<p>In this chapter we’ll estimate the <strong>encounter rate</strong> of Wood Thrush on eBird checklists in June in BCR 27. We define encounter rate as measuring the probability of an eBirder encountering a species on a standard eBird checklist.</p>
<p>The ecological metric we’re ultimately interested in is the probability that a species occurs at a site (i.e. the occupancy probability). This is usually not possible to estimate with semi-structured citizen science data like those from eBird because we typically can’t estimate <em>absolute</em> detectability. However, by accounting for much of the variation in detectability by including effort covariates in our model, the remaining unaccounted detectability will be more consistent across sites <span class="citation">(Guillera-Arroita et al. <a href="#ref-guillera-arroitaMySpeciesDistribution2015" role="doc-biblioref">2015</a>)</span>. Therefore, the encounter rate metric will be proportional to occupancy, albeit lower by some consistent amount. For some easily detectable species the difference between occurrence and actual occupancy rate will be small, and these encounter rates will approximate the actual occupancy rates of the species. For harder to detect species, the encounter rate may be substantially lower than the occupancy rate.</p>
<p><a href="https://en.wikipedia.org/wiki/Random_forest"><strong>Random forests</strong></a> are a general purpose machine learning method applicable to a wide range of <a href="https://en.wikipedia.org/wiki/Statistical_classification">classification</a> and <a href="https://en.wikipedia.org/wiki/Regression_analysis">regression</a> problems, including the task at hand: classifying detection and non-detection of a species on eBird checklists. In addition to having good predictive performance, random forests are reasonably easy to use and have several efficient implementations in R. Prior to fitting a random forest model, we’ll demonstrate how to address issues of <a href="intro.html#intro-intro">class imbalance and spatial bias</a> using spatial subsampling on a regular grid. After fitting the model, we’ll assess its performance using a subset of data put aside for testing, and calibrate the model to ensure predictions are accurate. Finally, we’ll predict encounter rates throughout the study area and produce maps of these predictions.</p>
</div>
<div id="encounter-data" class="section level2" number="4.2">
<h2><span class="header-section-number">4.2</span> Data preparation</h2>
<p>Let’s get started by loading the necessary packages and data. If you worked through the previous chapters, you should have all the data required for this chapter. However, you may want to <a href="https://github.com/cornelllabofornithology/ebird-best-practices/raw/master/data/data.zip">download the data package</a>, and unzip it to your project directory, to ensure you’re working with exactly the same data as was used in the creation of this book.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="encounter.html#cb36-1"></a><span class="kw">library</span>(sf)</span>
<span id="cb36-2"><a href="encounter.html#cb36-2"></a><span class="kw">library</span>(raster)</span>
<span id="cb36-3"><a href="encounter.html#cb36-3"></a><span class="kw">library</span>(dggridR)</span>
<span id="cb36-4"><a href="encounter.html#cb36-4"></a><span class="kw">library</span>(lubridate)</span>
<span id="cb36-5"><a href="encounter.html#cb36-5"></a><span class="kw">library</span>(ranger)</span>
<span id="cb36-6"><a href="encounter.html#cb36-6"></a><span class="kw">library</span>(scam)</span>
<span id="cb36-7"><a href="encounter.html#cb36-7"></a><span class="kw">library</span>(PresenceAbsence)</span>
<span id="cb36-8"><a href="encounter.html#cb36-8"></a><span class="kw">library</span>(verification)</span>
<span id="cb36-9"><a href="encounter.html#cb36-9"></a><span class="kw">library</span>(ebirdst)</span>
<span id="cb36-10"><a href="encounter.html#cb36-10"></a><span class="kw">library</span>(fields)</span>
<span id="cb36-11"><a href="encounter.html#cb36-11"></a><span class="kw">library</span>(gridExtra)</span>
<span id="cb36-12"><a href="encounter.html#cb36-12"></a><span class="kw">library</span>(tidyverse)</span>
<span id="cb36-13"><a href="encounter.html#cb36-13"></a><span class="co"># resolve namespace conflicts</span></span>
<span id="cb36-14"><a href="encounter.html#cb36-14"></a>select &lt;-<span class="st"> </span>dplyr<span class="op">::</span>select</span>
<span id="cb36-15"><a href="encounter.html#cb36-15"></a>map &lt;-<span class="st"> </span>purrr<span class="op">::</span>map</span>
<span id="cb36-16"><a href="encounter.html#cb36-16"></a>projection &lt;-<span class="st"> </span>raster<span class="op">::</span>projection</span>
<span id="cb36-17"><a href="encounter.html#cb36-17"></a></span>
<span id="cb36-18"><a href="encounter.html#cb36-18"></a><span class="co"># set random number seed to insure fully repeatable results</span></span>
<span id="cb36-19"><a href="encounter.html#cb36-19"></a><span class="kw">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb36-20"><a href="encounter.html#cb36-20"></a></span>
<span id="cb36-21"><a href="encounter.html#cb36-21"></a><span class="co"># setup output directory for saved results</span></span>
<span id="cb36-22"><a href="encounter.html#cb36-22"></a><span class="cf">if</span> (<span class="op">!</span><span class="kw">dir.exists</span>(<span class="st">&quot;output&quot;</span>)) {</span>
<span id="cb36-23"><a href="encounter.html#cb36-23"></a>  <span class="kw">dir.create</span>(<span class="st">&quot;output&quot;</span>)</span>
<span id="cb36-24"><a href="encounter.html#cb36-24"></a>}</span>
<span id="cb36-25"><a href="encounter.html#cb36-25"></a></span>
<span id="cb36-26"><a href="encounter.html#cb36-26"></a><span class="co"># ebird data</span></span>
<span id="cb36-27"><a href="encounter.html#cb36-27"></a>ebird &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;data/ebd_woothr_june_bcr27_zf.csv&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb36-28"><a href="encounter.html#cb36-28"></a><span class="st">  </span><span class="co"># year required to join to habitat data</span></span>
<span id="cb36-29"><a href="encounter.html#cb36-29"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">year =</span> <span class="kw">year</span>(observation_date))</span>
<span id="cb36-30"><a href="encounter.html#cb36-30"></a></span>
<span id="cb36-31"><a href="encounter.html#cb36-31"></a><span class="co"># modis habitat covariates</span></span>
<span id="cb36-32"><a href="encounter.html#cb36-32"></a>habitat &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;data/pland-elev_location-year.csv&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb36-33"><a href="encounter.html#cb36-33"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">year =</span> <span class="kw">as.integer</span>(year))</span>
<span id="cb36-34"><a href="encounter.html#cb36-34"></a></span>
<span id="cb36-35"><a href="encounter.html#cb36-35"></a><span class="co"># combine ebird and habitat data</span></span>
<span id="cb36-36"><a href="encounter.html#cb36-36"></a>ebird_habitat &lt;-<span class="st"> </span><span class="kw">inner_join</span>(ebird, habitat, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;locality_id&quot;</span>, <span class="st">&quot;year&quot;</span>))</span>
<span id="cb36-37"><a href="encounter.html#cb36-37"></a></span>
<span id="cb36-38"><a href="encounter.html#cb36-38"></a><span class="co"># prediction surface</span></span>
<span id="cb36-39"><a href="encounter.html#cb36-39"></a>pred_surface &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;data/pland-elev_prediction-surface.csv&quot;</span>)</span>
<span id="cb36-40"><a href="encounter.html#cb36-40"></a><span class="co"># latest year of landcover data</span></span>
<span id="cb36-41"><a href="encounter.html#cb36-41"></a>max_lc_year &lt;-<span class="st"> </span><span class="kw">max</span>(pred_surface<span class="op">$</span>year)</span>
<span id="cb36-42"><a href="encounter.html#cb36-42"></a>r &lt;-<span class="st"> </span><span class="kw">raster</span>(<span class="st">&quot;data/prediction-surface.tif&quot;</span>)</span>
<span id="cb36-43"><a href="encounter.html#cb36-43"></a></span>
<span id="cb36-44"><a href="encounter.html#cb36-44"></a><span class="co"># load gis data for making maps</span></span>
<span id="cb36-45"><a href="encounter.html#cb36-45"></a>map_proj &lt;-<span class="st"> </span><span class="kw">st_crs</span>(<span class="dv">102003</span>)</span>
<span id="cb36-46"><a href="encounter.html#cb36-46"></a>ne_land &lt;-<span class="st"> </span><span class="kw">read_sf</span>(<span class="st">&quot;data/gis-data.gpkg&quot;</span>, <span class="st">&quot;ne_land&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb36-47"><a href="encounter.html#cb36-47"></a><span class="st">  </span><span class="kw">st_transform</span>(<span class="dt">crs =</span> map_proj) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb36-48"><a href="encounter.html#cb36-48"></a><span class="st">  </span><span class="kw">st_geometry</span>()</span>
<span id="cb36-49"><a href="encounter.html#cb36-49"></a>bcr &lt;-<span class="st"> </span><span class="kw">read_sf</span>(<span class="st">&quot;data/gis-data.gpkg&quot;</span>, <span class="st">&quot;bcr&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb36-50"><a href="encounter.html#cb36-50"></a><span class="st">  </span><span class="kw">st_transform</span>(<span class="dt">crs =</span> map_proj) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb36-51"><a href="encounter.html#cb36-51"></a><span class="st">  </span><span class="kw">st_geometry</span>()</span>
<span id="cb36-52"><a href="encounter.html#cb36-52"></a>ne_country_lines &lt;-<span class="st"> </span><span class="kw">read_sf</span>(<span class="st">&quot;data/gis-data.gpkg&quot;</span>, <span class="st">&quot;ne_country_lines&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb36-53"><a href="encounter.html#cb36-53"></a><span class="st">  </span><span class="kw">st_transform</span>(<span class="dt">crs =</span> map_proj) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb36-54"><a href="encounter.html#cb36-54"></a><span class="st">  </span><span class="kw">st_geometry</span>()</span>
<span id="cb36-55"><a href="encounter.html#cb36-55"></a>ne_state_lines &lt;-<span class="st"> </span><span class="kw">read_sf</span>(<span class="st">&quot;data/gis-data.gpkg&quot;</span>, <span class="st">&quot;ne_state_lines&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb36-56"><a href="encounter.html#cb36-56"></a><span class="st">  </span><span class="kw">st_transform</span>(<span class="dt">crs =</span> map_proj) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb36-57"><a href="encounter.html#cb36-57"></a><span class="st">  </span><span class="kw">st_geometry</span>()</span></code></pre></div>
</div>
<div id="encounter-sss" class="section level2" number="4.3">
<h2><span class="header-section-number">4.3</span> Spatiotemporal subsampling</h2>
<p>As <a href="intro.html#intro-intro">discussed in the introduction</a>, three of the challenges faced when using eBird data, are <strong>spatial bias</strong>, <strong>temporal bias</strong>, and <strong>class imbalance</strong>. Spatial and temporal bias refers to the tendency of eBird checklists to be distributed non-randomly in space and time, while class imbalance refers to fact that there will be many more non-detections than detections for most species. All three can impact our ability to make reliable inferences from these data. Fortunately, all three can largely be addressed through subsampling the eBird data prior to modeling. In particular, we define an equal area hexagonal grid across the study region, and then subsample detections and non-detections separately to ensure that we don’t lose too many detections. In our example, we will be sampling one detection and one non-detection checklist from each grid cell for each week.</p>
<p>Hexagonal grids may seem exotic relative to square grids, which may be more familiar; however, they have a variety of benefits <span class="citation">(Sahr <a href="#ref-sahrHexagonalDiscreteGlobal2011" role="doc-biblioref">2011</a>)</span> including significantly less spatial distortion. With hexagonal grids we can be sure all the cells are of equal area, which is particularly important if we have a large region for modeling. The R package <a href="https://github.com/r-barnes/dggridR"><code>dggridR</code></a> makes working with hexagonal grids simple and efficient. We’ll construct a grid with 5 km spacing between the centres of adjacent hexagons, then sample randomly from these hexagonal cells.</p>
<p>Before working with the real data, it’s instructive to look at a simple toy example, to see how this subsampling process works. We’ll generate a few hundred random points, overlay a hexagonal grid, then sample one point from each cell.</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="encounter.html#cb37-1"></a><span class="co"># bounding box to generate points from</span></span>
<span id="cb37-2"><a href="encounter.html#cb37-2"></a>bb &lt;-<span class="st"> </span><span class="kw">st_bbox</span>(<span class="kw">c</span>(<span class="dt">xmin =</span> <span class="fl">-0.1</span>, <span class="dt">xmax =</span> <span class="fl">0.1</span>, <span class="dt">ymin =</span> <span class="fl">-0.1</span>, <span class="dt">ymax =</span> <span class="fl">0.1</span>), </span>
<span id="cb37-3"><a href="encounter.html#cb37-3"></a>              <span class="dt">crs =</span> <span class="dv">4326</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb37-4"><a href="encounter.html#cb37-4"></a><span class="st">  </span><span class="kw">st_as_sfc</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb37-5"><a href="encounter.html#cb37-5"></a><span class="st">  </span><span class="kw">st_sf</span>()</span>
<span id="cb37-6"><a href="encounter.html#cb37-6"></a><span class="co"># random points</span></span>
<span id="cb37-7"><a href="encounter.html#cb37-7"></a>pts &lt;-<span class="st"> </span><span class="kw">st_sample</span>(bb, <span class="dv">500</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb37-8"><a href="encounter.html#cb37-8"></a><span class="st">  </span><span class="kw">st_sf</span>(<span class="kw">as.data.frame</span>(<span class="kw">st_coordinates</span>(.)), <span class="dt">geometry =</span> .) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb37-9"><a href="encounter.html#cb37-9"></a><span class="st">  </span><span class="kw">rename</span>(<span class="dt">lat =</span> Y, <span class="dt">lon =</span> X)</span>
<span id="cb37-10"><a href="encounter.html#cb37-10"></a></span>
<span id="cb37-11"><a href="encounter.html#cb37-11"></a><span class="co"># contruct a hexagonal grid with ~ 5 km between cells</span></span>
<span id="cb37-12"><a href="encounter.html#cb37-12"></a>dggs &lt;-<span class="st"> </span><span class="kw">dgconstruct</span>(<span class="dt">spacing =</span> <span class="dv">5</span>)</span>
<span id="cb37-13"><a href="encounter.html#cb37-13"></a><span class="co"># for each point, get the grid cell</span></span>
<span id="cb37-14"><a href="encounter.html#cb37-14"></a>pts<span class="op">$</span>cell &lt;-<span class="st"> </span><span class="kw">dgGEO_to_SEQNUM</span>(dggs, pts<span class="op">$</span>lon, pts<span class="op">$</span>lat)<span class="op">$</span>seqnum</span>
<span id="cb37-15"><a href="encounter.html#cb37-15"></a></span>
<span id="cb37-16"><a href="encounter.html#cb37-16"></a><span class="co"># sample one checklist per grid cell</span></span>
<span id="cb37-17"><a href="encounter.html#cb37-17"></a>pts_ss &lt;-<span class="st"> </span>pts <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb37-18"><a href="encounter.html#cb37-18"></a><span class="st">  </span><span class="kw">group_by</span>(cell) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb37-19"><a href="encounter.html#cb37-19"></a><span class="st">  </span><span class="kw">sample_n</span>(<span class="dt">size =</span> <span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb37-20"><a href="encounter.html#cb37-20"></a><span class="st">  </span><span class="kw">ungroup</span>()</span>
<span id="cb37-21"><a href="encounter.html#cb37-21"></a></span>
<span id="cb37-22"><a href="encounter.html#cb37-22"></a><span class="co"># generate polygons for the grid cells</span></span>
<span id="cb37-23"><a href="encounter.html#cb37-23"></a>hexagons &lt;-<span class="st"> </span><span class="kw">dgcellstogrid</span>(dggs, <span class="kw">unique</span>(pts<span class="op">$</span>cell), <span class="dt">frame =</span> <span class="ot">FALSE</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb37-24"><a href="encounter.html#cb37-24"></a><span class="st">  </span><span class="kw">st_as_sf</span>()</span>
<span id="cb37-25"><a href="encounter.html#cb37-25"></a><span class="kw">ggplot</span>() <span class="op">+</span></span>
<span id="cb37-26"><a href="encounter.html#cb37-26"></a><span class="st">  </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> hexagons) <span class="op">+</span></span>
<span id="cb37-27"><a href="encounter.html#cb37-27"></a><span class="st">  </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> pts, <span class="dt">size =</span> <span class="fl">0.5</span>) <span class="op">+</span></span>
<span id="cb37-28"><a href="encounter.html#cb37-28"></a><span class="st">  </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> pts_ss, <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>) <span class="op">+</span></span>
<span id="cb37-29"><a href="encounter.html#cb37-29"></a><span class="st">  </span><span class="kw">theme_bw</span>()</span></code></pre></div>
<p><img src="ebird-best-practices_files/figure-html/encounter-sss-toy-1.png" width="\textwidth" style="display: block; margin: auto;" /></p>
<p>Now let’s apply exactly the same approach to subsampling the real eBird checklists; however, now we subsample temporally in addition to spatially, and sample detections and non-detections separately.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="encounter.html#cb38-1"></a><span class="co"># generate hexagonal grid with ~ 5 km betweeen cells</span></span>
<span id="cb38-2"><a href="encounter.html#cb38-2"></a>dggs &lt;-<span class="st"> </span><span class="kw">dgconstruct</span>(<span class="dt">spacing =</span> <span class="dv">5</span>)</span>
<span id="cb38-3"><a href="encounter.html#cb38-3"></a><span class="co"># get hexagonal cell id and week number for each checklist</span></span>
<span id="cb38-4"><a href="encounter.html#cb38-4"></a>checklist_cell &lt;-<span class="st"> </span>ebird_habitat <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb38-5"><a href="encounter.html#cb38-5"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">cell =</span> <span class="kw">dgGEO_to_SEQNUM</span>(dggs, longitude, latitude)<span class="op">$</span>seqnum,</span>
<span id="cb38-6"><a href="encounter.html#cb38-6"></a>         <span class="dt">year =</span> <span class="kw">year</span>(observation_date),</span>
<span id="cb38-7"><a href="encounter.html#cb38-7"></a>         <span class="dt">week =</span> <span class="kw">week</span>(observation_date))</span>
<span id="cb38-8"><a href="encounter.html#cb38-8"></a><span class="co"># sample one checklist per grid cell per week</span></span>
<span id="cb38-9"><a href="encounter.html#cb38-9"></a><span class="co"># sample detection/non-detection independently </span></span>
<span id="cb38-10"><a href="encounter.html#cb38-10"></a>ebird_ss &lt;-<span class="st"> </span>checklist_cell <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb38-11"><a href="encounter.html#cb38-11"></a><span class="st">  </span><span class="kw">group_by</span>(species_observed, year, week, cell) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb38-12"><a href="encounter.html#cb38-12"></a><span class="st">  </span><span class="kw">sample_n</span>(<span class="dt">size =</span> <span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb38-13"><a href="encounter.html#cb38-13"></a><span class="st">  </span><span class="kw">ungroup</span>()</span></code></pre></div>
<p>How did this impact the prevalence of detections compared to non-detections?</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="encounter.html#cb39-1"></a><span class="co"># original data</span></span>
<span id="cb39-2"><a href="encounter.html#cb39-2"></a><span class="kw">nrow</span>(ebird_habitat)</span>
<span id="cb39-3"><a href="encounter.html#cb39-3"></a><span class="co">#&gt; [1] 48450</span></span>
<span id="cb39-4"><a href="encounter.html#cb39-4"></a><span class="kw">count</span>(ebird_habitat, species_observed) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb39-5"><a href="encounter.html#cb39-5"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">percent =</span> n <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(n))</span>
<span id="cb39-6"><a href="encounter.html#cb39-6"></a><span class="co">#&gt; # A tibble: 2 x 3</span></span>
<span id="cb39-7"><a href="encounter.html#cb39-7"></a><span class="co">#&gt;   species_observed     n percent</span></span>
<span id="cb39-8"><a href="encounter.html#cb39-8"></a><span class="co">#&gt;   &lt;lgl&gt;            &lt;int&gt;   &lt;dbl&gt;</span></span>
<span id="cb39-9"><a href="encounter.html#cb39-9"></a><span class="co">#&gt; 1 FALSE            46355  0.957 </span></span>
<span id="cb39-10"><a href="encounter.html#cb39-10"></a><span class="co">#&gt; 2 TRUE              2095  0.0432</span></span>
<span id="cb39-11"><a href="encounter.html#cb39-11"></a></span>
<span id="cb39-12"><a href="encounter.html#cb39-12"></a><span class="co"># after sampling</span></span>
<span id="cb39-13"><a href="encounter.html#cb39-13"></a><span class="kw">nrow</span>(ebird_ss)</span>
<span id="cb39-14"><a href="encounter.html#cb39-14"></a><span class="co">#&gt; [1] 20093</span></span>
<span id="cb39-15"><a href="encounter.html#cb39-15"></a><span class="kw">count</span>(ebird_ss, species_observed) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb39-16"><a href="encounter.html#cb39-16"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">percent =</span> n <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(n))</span>
<span id="cb39-17"><a href="encounter.html#cb39-17"></a><span class="co">#&gt; # A tibble: 2 x 3</span></span>
<span id="cb39-18"><a href="encounter.html#cb39-18"></a><span class="co">#&gt;   species_observed     n percent</span></span>
<span id="cb39-19"><a href="encounter.html#cb39-19"></a><span class="co">#&gt;   &lt;lgl&gt;            &lt;int&gt;   &lt;dbl&gt;</span></span>
<span id="cb39-20"><a href="encounter.html#cb39-20"></a><span class="co">#&gt; 1 FALSE            18617  0.927 </span></span>
<span id="cb39-21"><a href="encounter.html#cb39-21"></a><span class="co">#&gt; 2 TRUE              1476  0.0735</span></span></code></pre></div>
<p>So, the subsampling <em>decreased</em> the overall number of checklists by a factor of about four, but <em>increased</em> the prevalence of detections from 4% to 7%. This increase in detections will help the random forest model distinguish where birds are being observed; however, this does affect the prevalence rate of the detections in the data. As a result, the estimated probability of occurrence based on these subsampled data will be larger than the true occurrence rate. When examining the outputs from the models it will be important to recall that we altered the prevalence rate at this stage. Now let’s look at how the subsampling affects the spatial distribution of the observations.</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="encounter.html#cb40-1"></a><span class="co"># convert checklists to spatial features</span></span>
<span id="cb40-2"><a href="encounter.html#cb40-2"></a>all_pts &lt;-<span class="st"> </span>ebird_habitat <span class="op">%&gt;%</span><span class="st">  </span></span>
<span id="cb40-3"><a href="encounter.html#cb40-3"></a><span class="st">  </span><span class="kw">st_as_sf</span>(<span class="dt">coords =</span> <span class="kw">c</span>(<span class="st">&quot;longitude&quot;</span>,<span class="st">&quot;latitude&quot;</span>), <span class="dt">crs =</span> <span class="dv">4326</span>) <span class="op">%&gt;%</span></span>
<span id="cb40-4"><a href="encounter.html#cb40-4"></a><span class="st">  </span><span class="kw">st_transform</span>(<span class="dt">crs =</span> map_proj) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb40-5"><a href="encounter.html#cb40-5"></a><span class="st">  </span><span class="kw">select</span>(species_observed)</span>
<span id="cb40-6"><a href="encounter.html#cb40-6"></a>ss_pts &lt;-<span class="st"> </span>ebird_ss <span class="op">%&gt;%</span><span class="st">  </span></span>
<span id="cb40-7"><a href="encounter.html#cb40-7"></a><span class="st">  </span><span class="kw">st_as_sf</span>(<span class="dt">coords =</span> <span class="kw">c</span>(<span class="st">&quot;longitude&quot;</span>,<span class="st">&quot;latitude&quot;</span>), <span class="dt">crs =</span> <span class="dv">4326</span>) <span class="op">%&gt;%</span></span>
<span id="cb40-8"><a href="encounter.html#cb40-8"></a><span class="st">  </span><span class="kw">st_transform</span>(<span class="dt">crs =</span> map_proj) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb40-9"><a href="encounter.html#cb40-9"></a><span class="st">  </span><span class="kw">select</span>(species_observed)</span>
<span id="cb40-10"><a href="encounter.html#cb40-10"></a>both_pts &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">before_ss =</span> all_pts, <span class="dt">after_ss =</span> ss_pts)</span>
<span id="cb40-11"><a href="encounter.html#cb40-11"></a></span>
<span id="cb40-12"><a href="encounter.html#cb40-12"></a><span class="co"># map</span></span>
<span id="cb40-13"><a href="encounter.html#cb40-13"></a>p &lt;-<span class="st"> </span><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">1</span>))</span>
<span id="cb40-14"><a href="encounter.html#cb40-14"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="kw">seq_along</span>(both_pts)) {</span>
<span id="cb40-15"><a href="encounter.html#cb40-15"></a>  <span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="fl">0.25</span>, <span class="fl">0.25</span>, <span class="fl">0.25</span>, <span class="fl">0.25</span>))</span>
<span id="cb40-16"><a href="encounter.html#cb40-16"></a>  <span class="co"># set up plot area</span></span>
<span id="cb40-17"><a href="encounter.html#cb40-17"></a>  <span class="kw">plot</span>(<span class="kw">st_geometry</span>(both_pts[[i]]), <span class="dt">col =</span> <span class="ot">NA</span>)</span>
<span id="cb40-18"><a href="encounter.html#cb40-18"></a>  <span class="co"># contextual gis data</span></span>
<span id="cb40-19"><a href="encounter.html#cb40-19"></a>  <span class="kw">plot</span>(ne_land, <span class="dt">col =</span> <span class="st">&quot;#dddddd&quot;</span>, <span class="dt">border =</span> <span class="st">&quot;#888888&quot;</span>, <span class="dt">lwd =</span> <span class="fl">0.5</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</span>
<span id="cb40-20"><a href="encounter.html#cb40-20"></a>  <span class="kw">plot</span>(bcr, <span class="dt">col =</span> <span class="st">&quot;#cccccc&quot;</span>, <span class="dt">border =</span> <span class="ot">NA</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</span>
<span id="cb40-21"><a href="encounter.html#cb40-21"></a>  <span class="kw">plot</span>(ne_state_lines, <span class="dt">col =</span> <span class="st">&quot;#ffffff&quot;</span>, <span class="dt">lwd =</span> <span class="fl">0.75</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</span>
<span id="cb40-22"><a href="encounter.html#cb40-22"></a>  <span class="kw">plot</span>(ne_country_lines, <span class="dt">col =</span> <span class="st">&quot;#ffffff&quot;</span>, <span class="dt">lwd =</span> <span class="fl">1.5</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</span>
<span id="cb40-23"><a href="encounter.html#cb40-23"></a>  <span class="co"># ebird observations</span></span>
<span id="cb40-24"><a href="encounter.html#cb40-24"></a>  <span class="co"># not observed</span></span>
<span id="cb40-25"><a href="encounter.html#cb40-25"></a>  <span class="kw">plot</span>(<span class="kw">st_geometry</span>(both_pts[[i]]),</span>
<span id="cb40-26"><a href="encounter.html#cb40-26"></a>       <span class="dt">pch =</span> <span class="dv">19</span>, <span class="dt">cex =</span> <span class="fl">0.1</span>, <span class="dt">col =</span> <span class="kw">alpha</span>(<span class="st">&quot;#555555&quot;</span>, <span class="fl">0.25</span>),</span>
<span id="cb40-27"><a href="encounter.html#cb40-27"></a>       <span class="dt">add =</span> <span class="ot">TRUE</span>)</span>
<span id="cb40-28"><a href="encounter.html#cb40-28"></a>  <span class="co"># observed</span></span>
<span id="cb40-29"><a href="encounter.html#cb40-29"></a>  <span class="kw">plot</span>(<span class="kw">filter</span>(both_pts[[i]], species_observed) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_geometry</span>(),</span>
<span id="cb40-30"><a href="encounter.html#cb40-30"></a>       <span class="dt">pch =</span> <span class="dv">19</span>, <span class="dt">cex =</span> <span class="fl">0.3</span>, <span class="dt">col =</span> <span class="kw">alpha</span>(<span class="st">&quot;#4daf4a&quot;</span>, <span class="fl">0.5</span>),</span>
<span id="cb40-31"><a href="encounter.html#cb40-31"></a>       <span class="dt">add =</span> <span class="ot">TRUE</span>)</span>
<span id="cb40-32"><a href="encounter.html#cb40-32"></a>  <span class="co"># legend</span></span>
<span id="cb40-33"><a href="encounter.html#cb40-33"></a>  <span class="kw">legend</span>(<span class="st">&quot;bottomright&quot;</span>, <span class="dt">bty =</span> <span class="st">&quot;n&quot;</span>,</span>
<span id="cb40-34"><a href="encounter.html#cb40-34"></a>         <span class="dt">col =</span> <span class="kw">c</span>(<span class="st">&quot;#555555&quot;</span>, <span class="st">&quot;#4daf4a&quot;</span>),</span>
<span id="cb40-35"><a href="encounter.html#cb40-35"></a>         <span class="dt">legend =</span> <span class="kw">c</span>(<span class="st">&quot;Non-detection&quot;</span>, <span class="st">&quot;Detection&quot;</span>),</span>
<span id="cb40-36"><a href="encounter.html#cb40-36"></a>         <span class="dt">pch =</span> <span class="dv">19</span>)</span>
<span id="cb40-37"><a href="encounter.html#cb40-37"></a>  <span class="kw">box</span>()</span>
<span id="cb40-38"><a href="encounter.html#cb40-38"></a>  <span class="kw">par</span>(<span class="dt">new =</span> <span class="ot">TRUE</span>, <span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">3</span>, <span class="dv">0</span>))</span>
<span id="cb40-39"><a href="encounter.html#cb40-39"></a>  <span class="cf">if</span> (<span class="kw">names</span>(both_pts)[i] <span class="op">==</span><span class="st"> &quot;before_ss&quot;</span>) {</span>
<span id="cb40-40"><a href="encounter.html#cb40-40"></a>    <span class="kw">title</span>(<span class="st">&quot;Wood Thrush eBird Observations</span><span class="ch">\n</span><span class="st">Before subsampling&quot;</span>)</span>
<span id="cb40-41"><a href="encounter.html#cb40-41"></a>  } <span class="cf">else</span> {</span>
<span id="cb40-42"><a href="encounter.html#cb40-42"></a>    <span class="kw">title</span>(<span class="st">&quot;After subsampling&quot;</span>)</span>
<span id="cb40-43"><a href="encounter.html#cb40-43"></a>  }</span>
<span id="cb40-44"><a href="encounter.html#cb40-44"></a>}</span>
<span id="cb40-45"><a href="encounter.html#cb40-45"></a><span class="kw">par</span>(p)</span></code></pre></div>
<p><img src="ebird-best-practices_files/figure-html/encounter-sss-map-1.png" width="\textwidth" style="display: block; margin: auto;" /></p>
<p>For Wood Thrush, subsampling the detections and non-detections independently is sufficient for dealing with class imbalance. You can assess the impact of class imbalance by looking at the prevalence rates and examining whether the models are good at predicting to validation data. For species that are extremely rare, it may be worthwhile considering keeping all detections or even oversampling detections <span class="citation">(Robinson, Ruiz‐Gutierrez, and Fink <a href="#ref-robinsonCorrectingBiasDistribution2018" role="doc-biblioref">2018</a>)</span>. In doing this, be aware that some of your species detections will not be independent, which could lead to overfitting of the data. Overall, when thinking about the number of detections and the prevalence rate, it’s important to consider both the ecology and detectability of the focal species, and the behavior of observers towards this species.</p>
</div>
<div id="encounter-rf" class="section level2" number="4.4">
<h2><span class="header-section-number">4.4</span> Random forests</h2>
<p>Now we’ll use a random forest model to relate detection/non-detection of Wood Thrush to the habitat covariates (MODIS land cover and elevation), while also accounting for variation in detectability by including a suite of effort covariates. Before we fit the random forest model, we randomly split the data into 80% of checklists for training and 20% for testing. We’ll hold this 20% aside when we fit the model, then use it as an independent data set to test the predictive performance of the model.</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="encounter.html#cb41-1"></a>ebird_split &lt;-<span class="st"> </span>ebird_ss <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb41-2"><a href="encounter.html#cb41-2"></a><span class="st">  </span><span class="co"># select only the columns to be used in the model</span></span>
<span id="cb41-3"><a href="encounter.html#cb41-3"></a><span class="st">  </span><span class="kw">select</span>(species_observed,</span>
<span id="cb41-4"><a href="encounter.html#cb41-4"></a>         year, day_of_year,</span>
<span id="cb41-5"><a href="encounter.html#cb41-5"></a>         time_observations_started, duration_minutes,</span>
<span id="cb41-6"><a href="encounter.html#cb41-6"></a>         effort_distance_km, number_observers, </span>
<span id="cb41-7"><a href="encounter.html#cb41-7"></a>         <span class="kw">starts_with</span>(<span class="st">&quot;pland_&quot;</span>),</span>
<span id="cb41-8"><a href="encounter.html#cb41-8"></a>         <span class="kw">starts_with</span>(<span class="st">&quot;elevation_&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb41-9"><a href="encounter.html#cb41-9"></a><span class="st">  </span><span class="kw">drop_na</span>()</span>
<span id="cb41-10"><a href="encounter.html#cb41-10"></a><span class="co"># split 80/20</span></span>
<span id="cb41-11"><a href="encounter.html#cb41-11"></a>ebird_split &lt;-<span class="st"> </span>ebird_split <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb41-12"><a href="encounter.html#cb41-12"></a><span class="st">  </span><span class="kw">split</span>(<span class="kw">if_else</span>(<span class="kw">runif</span>(<span class="kw">nrow</span>(.)) <span class="op">&lt;=</span><span class="st"> </span><span class="fl">0.8</span>, <span class="st">&quot;train&quot;</span>, <span class="st">&quot;test&quot;</span>))</span>
<span id="cb41-13"><a href="encounter.html#cb41-13"></a><span class="kw">map_int</span>(ebird_split, nrow)</span>
<span id="cb41-14"><a href="encounter.html#cb41-14"></a><span class="co">#&gt;  test train </span></span>
<span id="cb41-15"><a href="encounter.html#cb41-15"></a><span class="co">#&gt;  3938 16135</span></span></code></pre></div>
<p>Although we were able to partially address the issue of class imbalance via subsampling, detections still only make up 7% of observations, and for rare species this number will be even lower. Most classification algorithms aim to minimize the overall error rate, which results in poor predictive performance for rare classes <span class="citation">(Chen, Liaw, and Breiman <a href="#ref-chen2004using" role="doc-biblioref">2004</a>)</span>. To address this issue, we’ll use a balanced random forest approach, a modification of the traditional random forest algorithm designed to handle imbalanced data. In this approach, each of the trees that makes up the random forest is generated using a random sample of the data chosen such that there is an equal number of the detections (the rare class) and non-detections (the common class). To use this approach, we’ll need to calculate the proportion of detections in the dataset.</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="encounter.html#cb42-1"></a>detection_freq &lt;-<span class="st"> </span><span class="kw">mean</span>(ebird_split<span class="op">$</span>train<span class="op">$</span>species_observed)</span></code></pre></div>
<p>There are several packages for fitting random forests in R; however, we’ll use <a href="https://github.com/imbs-hl/ranger"><code>ranger</code></a>, which is a blazingly fast implementation with all the features we need. To fit a balanced random forest, we use the <code>sample.fraction</code> parameter to instruct <code>ranger</code> to grow each tree based on a random sample of the data that has an equal number of detections and non-detections. Specifying this is somewhat obtuse, because we need to tell ranger the proportion of the total data set to sample for non-detections and detections, and when this proportion is the same as the proportion of the rarer class–the detections–then then ranger will sample from all of the rarer class but from an equally sized subset of the more common non-detections. We use <code>replace = TRUE</code> to ensure that it’s a <a href="https://en.wikipedia.org/wiki/Bootstrapping_(statistics)">bootstrap sample</a>. We’ll also ask <code>ranger</code> to predict probabilities, rather than simply returning the most probable class, with <code>probability = TRUE</code>.</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="encounter.html#cb43-1"></a><span class="co"># ranger requires a factor response to do classification</span></span>
<span id="cb43-2"><a href="encounter.html#cb43-2"></a>ebird_split<span class="op">$</span>train<span class="op">$</span>species_observed &lt;-<span class="st"> </span><span class="kw">factor</span>(ebird_split<span class="op">$</span>train<span class="op">$</span>species_observed)</span>
<span id="cb43-3"><a href="encounter.html#cb43-3"></a><span class="co"># grow random forest</span></span>
<span id="cb43-4"><a href="encounter.html#cb43-4"></a>rf &lt;-<span class="st"> </span><span class="kw">ranger</span>(<span class="dt">formula =</span>  species_observed <span class="op">~</span><span class="st"> </span>., </span>
<span id="cb43-5"><a href="encounter.html#cb43-5"></a>             <span class="dt">data =</span> ebird_split<span class="op">$</span>train,</span>
<span id="cb43-6"><a href="encounter.html#cb43-6"></a>             <span class="dt">importance =</span> <span class="st">&quot;impurity&quot;</span>,</span>
<span id="cb43-7"><a href="encounter.html#cb43-7"></a>             <span class="dt">probability =</span> <span class="ot">TRUE</span>,</span>
<span id="cb43-8"><a href="encounter.html#cb43-8"></a>             <span class="dt">replace =</span> <span class="ot">TRUE</span>, </span>
<span id="cb43-9"><a href="encounter.html#cb43-9"></a>             <span class="dt">sample.fraction =</span> <span class="kw">c</span>(detection_freq, detection_freq))</span></code></pre></div>
<div id="encounter-rf-cal" class="section level3" number="4.4.1">
<h3><span class="header-section-number">4.4.1</span> Calibration</h3>
<p>For various reasons, the predicted probabilities from models do not always align with the observed frequencies of detections. For example, we would hope that if we look at all sites with a estimated probability of encounter of 0.2, that 20% of these would record the species. However, these probabilities are not always so well aligned. This will clearly be the case in our example, because we have deliberately inflated the prevalence of detection records in the data through the spatiotemporal subsampling process. We can produce a <strong>calibration</strong> of the predictions, which can be a useful diagnostic tool to understand the model predictions, and in some cases can be used to realign the predictions with observations. For information on calibration in species distribution models see Vaughan and Ormerod <span class="citation">(<a href="#ref-vaughanContinuingChallengesTesting2005" role="doc-biblioref">2005</a>)</span> and for more fundamental references on calibration see Platt <span class="citation">(<a href="#ref-plattProbabilisticOutputsSupport1999" role="doc-biblioref">1999</a>)</span>, Murphy <span class="citation">(<a href="#ref-murphyNewVectorPartition1973" role="doc-biblioref">1973</a>)</span>, and Niculescu-Mizil and Caruana <span class="citation">(<a href="#ref-niculescu-mizilPredictingGoodProbabilities2005" role="doc-biblioref">2005</a>)</span>.</p>
<p>To view the calibration of our model results, we predict encounter rate for each checklist in the training set, then fit a binomial Generalized Additive Model (GAM) with the real observed encounter rate as the response and the predicted encounter rate as the predictor variable. Whereas GLMs fit a linear relationship between a response and predictors, GAMs allow non-linear relationships. Although GAMs provide a degree of flexibility, however in some situations they may overfit and provide unrealistic and unhelpful calibrations. We have a strong a priori expectation that higher real values will also be associated with higher estimated rates. In order to maintain the ranking of predictions, it is important that we respect this ordering and to do this we’ll use a GAM that is constrained to only increase. To fit the GAM, we’ll use the R package <a href="https://CRAN.R-project.org/package=scam"><code>scam</code></a>, so the shape can be constrained to be monotonically increasing. Note that predictions from <code>ranger</code> are in the form of a matrix of probabilities for each class, and we want the probability of detections, which is the second column of this matrix.</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="encounter.html#cb44-1"></a><span class="co"># make predictions on training data</span></span>
<span id="cb44-2"><a href="encounter.html#cb44-2"></a>occ_pred &lt;-<span class="st"> </span>rf<span class="op">$</span>predictions[, <span class="dv">2</span>]</span>
<span id="cb44-3"><a href="encounter.html#cb44-3"></a><span class="co"># convert the observered response back to a numeric value from factor</span></span>
<span id="cb44-4"><a href="encounter.html#cb44-4"></a>occ_obs &lt;-<span class="st"> </span>ebird_split<span class="op">$</span>train<span class="op">$</span>species_observed <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb44-5"><a href="encounter.html#cb44-5"></a><span class="st">  </span><span class="kw">as.logical</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb44-6"><a href="encounter.html#cb44-6"></a><span class="st">  </span><span class="kw">as.integer</span>()</span>
<span id="cb44-7"><a href="encounter.html#cb44-7"></a>rf_pred_train &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">obs =</span> occ_obs, <span class="dt">pred =</span> occ_pred) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb44-8"><a href="encounter.html#cb44-8"></a><span class="st">  </span><span class="kw">drop_na</span>()</span>
<span id="cb44-9"><a href="encounter.html#cb44-9"></a></span>
<span id="cb44-10"><a href="encounter.html#cb44-10"></a><span class="co"># fit calibration model</span></span>
<span id="cb44-11"><a href="encounter.html#cb44-11"></a>calibration_model &lt;-<span class="st"> </span><span class="kw">scam</span>(obs <span class="op">~</span><span class="st"> </span><span class="kw">s</span>(pred, <span class="dt">k =</span> <span class="dv">5</span>, <span class="dt">bs =</span> <span class="st">&quot;mpi&quot;</span>), </span>
<span id="cb44-12"><a href="encounter.html#cb44-12"></a>                          <span class="dt">gamma =</span> <span class="fl">1.4</span>,</span>
<span id="cb44-13"><a href="encounter.html#cb44-13"></a>                          <span class="dt">data =</span> rf_pred_train)</span>
<span id="cb44-14"><a href="encounter.html#cb44-14"></a></span>
<span id="cb44-15"><a href="encounter.html#cb44-15"></a><span class="co"># calculate the average observed encounter rates for different </span></span>
<span id="cb44-16"><a href="encounter.html#cb44-16"></a><span class="co"># categories of estimated encounter rates </span></span>
<span id="cb44-17"><a href="encounter.html#cb44-17"></a></span>
<span id="cb44-18"><a href="encounter.html#cb44-18"></a>average_encounter &lt;-<span class="st"> </span>rf_pred_train <span class="op">%&gt;%</span></span>
<span id="cb44-19"><a href="encounter.html#cb44-19"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">pred_cat =</span> <span class="kw">cut</span>(rf_pred_train<span class="op">$</span>pred, <span class="dt">breaks =</span> <span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dt">by=</span><span class="fl">0.02</span>))) <span class="op">%&gt;%</span></span>
<span id="cb44-20"><a href="encounter.html#cb44-20"></a><span class="st">  </span><span class="kw">group_by</span>(pred_cat) <span class="op">%&gt;%</span></span>
<span id="cb44-21"><a href="encounter.html#cb44-21"></a><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">pred =</span> <span class="kw">mean</span>(pred), <span class="dt">obs =</span> <span class="kw">mean</span>(obs), <span class="dt">checklist_count =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span></span>
<span id="cb44-22"><a href="encounter.html#cb44-22"></a><span class="st">  </span><span class="kw">ungroup</span>()</span>
<span id="cb44-23"><a href="encounter.html#cb44-23"></a></span>
<span id="cb44-24"><a href="encounter.html#cb44-24"></a><span class="co"># plot</span></span>
<span id="cb44-25"><a href="encounter.html#cb44-25"></a>cal_pred &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">pred =</span> <span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dt">length.out =</span> <span class="dv">100</span>))</span>
<span id="cb44-26"><a href="encounter.html#cb44-26"></a>cal_pred &lt;-<span class="st"> </span><span class="kw">predict</span>(calibration_model, cal_pred, <span class="dt">type =</span> <span class="st">&quot;response&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb44-27"><a href="encounter.html#cb44-27"></a><span class="st">  </span><span class="kw">bind_cols</span>(cal_pred, <span class="dt">calibrated =</span> .)</span>
<span id="cb44-28"><a href="encounter.html#cb44-28"></a><span class="kw">ggplot</span>(cal_pred) <span class="op">+</span></span>
<span id="cb44-29"><a href="encounter.html#cb44-29"></a><span class="st">  </span><span class="kw">aes</span>(<span class="dt">x =</span> pred, <span class="dt">y =</span> calibrated) <span class="op">+</span></span>
<span id="cb44-30"><a href="encounter.html#cb44-30"></a><span class="st">  </span><span class="kw">geom_line</span>() <span class="op">+</span></span>
<span id="cb44-31"><a href="encounter.html#cb44-31"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> average_encounter, </span>
<span id="cb44-32"><a href="encounter.html#cb44-32"></a>             <span class="kw">aes</span>(<span class="dt">x =</span> pred, <span class="dt">y =</span> obs, <span class="dt">size =</span> <span class="kw">sqrt</span>(checklist_count)),</span>
<span id="cb44-33"><a href="encounter.html#cb44-33"></a>             <span class="dt">show.legend =</span> <span class="ot">FALSE</span>, <span class="dt">shape =</span> <span class="dv">1</span>) <span class="op">+</span></span>
<span id="cb44-34"><a href="encounter.html#cb44-34"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Estimated encounter rate&quot;</span>,</span>
<span id="cb44-35"><a href="encounter.html#cb44-35"></a>       <span class="dt">y =</span> <span class="st">&quot;Observed encounter rate&quot;</span>,</span>
<span id="cb44-36"><a href="encounter.html#cb44-36"></a>       <span class="dt">title =</span> <span class="st">&quot;Calibration model&quot;</span>)</span></code></pre></div>
<p><img src="ebird-best-practices_files/figure-html/encounter-rf-cal-cal-1.png" width="\textwidth" style="display: block; margin: auto;" /></p>
<p>Using this as a diagnostic tool, we can clearly see that the estimated encounter rates are mostly much larger than the observed encounter rates. So we see that the model is not well calibrated. However, we do see from the points that the relative ranking of predictions is largely good. Sites with estimated higher encounter rate do mostly have higher encounter rates.</p>
<p>From this we have learnt that the model is good at distinguishing sites with high rates from those with low rates. For those readers familiar with using AUC scores to assess the quality of species distribution models, the graph is telling us that the model should have a high AUC value. However, the model is not so good at estimating encounter rates accurately.</p>
<p>If accurate encounter rates are required, and the calibration model is strong (close fit of points to the line in the figure above), then the calibration model can be used to <strong>calibrate</strong> the estimates from the random forest model, so they are adjusted to match the observed encounter rates more closely. The calibrated random forest model is the combination of the original random forest model followed by the calibration model.</p>
<p>If you’re using this model to calibrate your estimates, notice that the calibration curve can produce probabilities greater than 1 and less than 0, so when applying the calibration we also need to restrict the predictions to be between 0 and 1. It’s possible to run a logistic regression for the calibration to remove these predictions less than 0 or greater than 1; however, we’ve found the Gaussian constrained GAM to be more stable than the logistic constrained GAM.</p>
</div>
<div id="encounter-rf-assess" class="section level3" number="4.4.2">
<h3><span class="header-section-number">4.4.2</span> Assessment</h3>
<p>To assess the quality of both the uncalibrated and the calibrated model, we’ll validate the model’s ability to predict the observed patterns of occupancy using independent validation data (i.e. the 20% test data set). We’ll use a range of predictive performance metrics to compare the predictions to the actual observations: <a href="https://en.wikipedia.org/wiki/Mean_squared_error">mean squared error (MSE)</a>, <a href="https://en.wikipedia.org/wiki/Sensitivity_and_specificity">sensitivity</a>, <a href="https://en.wikipedia.org/wiki/Sensitivity_and_specificity">specificity</a>, <a href="https://en.wikipedia.org/wiki/Receiver_operating_characteristic#Area_under_the_curve">AUC</a>, and <a href="https://en.wikipedia.org/wiki/Cohen%27s_kappa">Kappa</a>. Several of these metrics require the predicted probabilities to be classified into detection/non-detection. We’ll do this using a threshold, chosen to maximize the Kappa statistic.</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="encounter.html#cb45-1"></a><span class="co"># predict on test data using calibrated model</span></span>
<span id="cb45-2"><a href="encounter.html#cb45-2"></a>p_fitted &lt;-<span class="st"> </span><span class="kw">predict</span>(rf, <span class="dt">data =</span> ebird_split<span class="op">$</span>test, <span class="dt">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb45-3"><a href="encounter.html#cb45-3"></a><span class="co"># extract probability of detection</span></span>
<span id="cb45-4"><a href="encounter.html#cb45-4"></a>p_fitted &lt;-<span class="st"> </span>p_fitted<span class="op">$</span>predictions[, <span class="dv">2</span>]</span>
<span id="cb45-5"><a href="encounter.html#cb45-5"></a><span class="co"># calibrate</span></span>
<span id="cb45-6"><a href="encounter.html#cb45-6"></a>p_calibrated &lt;-<span class="st"> </span><span class="kw">predict</span>(calibration_model, </span>
<span id="cb45-7"><a href="encounter.html#cb45-7"></a>                        <span class="dt">newdata =</span> <span class="kw">tibble</span>(<span class="dt">pred =</span> p_fitted), </span>
<span id="cb45-8"><a href="encounter.html#cb45-8"></a>                        <span class="dt">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb45-9"><a href="encounter.html#cb45-9"></a>rf_pred_test &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">id =</span> <span class="kw">seq_along</span>(p_calibrated),</span>
<span id="cb45-10"><a href="encounter.html#cb45-10"></a>                           <span class="co"># actual detection/non-detection</span></span>
<span id="cb45-11"><a href="encounter.html#cb45-11"></a>                           <span class="dt">obs =</span> ebird_split<span class="op">$</span>test<span class="op">$</span>species_observed,</span>
<span id="cb45-12"><a href="encounter.html#cb45-12"></a>                           <span class="co"># uncalibrated prediction</span></span>
<span id="cb45-13"><a href="encounter.html#cb45-13"></a>                           <span class="dt">fit =</span> p_fitted,</span>
<span id="cb45-14"><a href="encounter.html#cb45-14"></a>                           <span class="co"># calibrated prediction</span></span>
<span id="cb45-15"><a href="encounter.html#cb45-15"></a>                           <span class="dt">cal =</span> p_calibrated) <span class="op">%&gt;%</span></span>
<span id="cb45-16"><a href="encounter.html#cb45-16"></a><span class="st">  </span><span class="co"># constrain probabilities to 0-1</span></span>
<span id="cb45-17"><a href="encounter.html#cb45-17"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">cal =</span> <span class="kw">pmin</span>(<span class="kw">pmax</span>(cal, <span class="dv">0</span>), <span class="dv">1</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb45-18"><a href="encounter.html#cb45-18"></a><span class="st">  </span><span class="kw">drop_na</span>()</span>
<span id="cb45-19"><a href="encounter.html#cb45-19"></a></span>
<span id="cb45-20"><a href="encounter.html#cb45-20"></a><span class="co"># mean squared error (mse)</span></span>
<span id="cb45-21"><a href="encounter.html#cb45-21"></a>mse_fit &lt;-<span class="st"> </span><span class="kw">mean</span>((rf_pred_test<span class="op">$</span>obs <span class="op">-</span><span class="st"> </span>rf_pred_test<span class="op">$</span>fit)<span class="op">^</span><span class="dv">2</span>, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</span>
<span id="cb45-22"><a href="encounter.html#cb45-22"></a>mse_cal &lt;-<span class="st"> </span><span class="kw">mean</span>((rf_pred_test<span class="op">$</span>obs <span class="op">-</span><span class="st"> </span>rf_pred_test<span class="op">$</span>cal)<span class="op">^</span><span class="dv">2</span>, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</span>
<span id="cb45-23"><a href="encounter.html#cb45-23"></a></span>
<span id="cb45-24"><a href="encounter.html#cb45-24"></a><span class="co"># pick threshold to maximize kappa</span></span>
<span id="cb45-25"><a href="encounter.html#cb45-25"></a>opt_thresh &lt;-<span class="st"> </span><span class="kw">optimal.thresholds</span>(rf_pred_test, <span class="dt">opt.methods =</span> <span class="st">&quot;MaxKappa&quot;</span>)</span>
<span id="cb45-26"><a href="encounter.html#cb45-26"></a></span>
<span id="cb45-27"><a href="encounter.html#cb45-27"></a><span class="co"># calculate accuracy metrics: auc, kappa, sensitivity, specificity,</span></span>
<span id="cb45-28"><a href="encounter.html#cb45-28"></a>metrics_fit &lt;-<span class="st"> </span>rf_pred_test <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb45-29"><a href="encounter.html#cb45-29"></a><span class="st">  </span><span class="kw">select</span>(id, obs, fit) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb45-30"><a href="encounter.html#cb45-30"></a><span class="st">  </span><span class="kw">presence.absence.accuracy</span>(<span class="dt">threshold =</span> opt_thresh<span class="op">$</span>fit, </span>
<span id="cb45-31"><a href="encounter.html#cb45-31"></a>                            <span class="dt">na.rm =</span> <span class="ot">TRUE</span>, </span>
<span id="cb45-32"><a href="encounter.html#cb45-32"></a>                            <span class="dt">st.dev =</span> <span class="ot">FALSE</span>)</span>
<span id="cb45-33"><a href="encounter.html#cb45-33"></a>metrics_cal &lt;-<span class="st"> </span>rf_pred_test <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb45-34"><a href="encounter.html#cb45-34"></a><span class="st">  </span><span class="kw">select</span>(id, obs, cal) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb45-35"><a href="encounter.html#cb45-35"></a><span class="st">  </span><span class="kw">presence.absence.accuracy</span>(<span class="dt">threshold =</span> opt_thresh<span class="op">$</span>cal, </span>
<span id="cb45-36"><a href="encounter.html#cb45-36"></a>                            <span class="dt">na.rm =</span> <span class="ot">TRUE</span>, </span>
<span id="cb45-37"><a href="encounter.html#cb45-37"></a>                            <span class="dt">st.dev =</span> <span class="ot">FALSE</span>)</span>
<span id="cb45-38"><a href="encounter.html#cb45-38"></a></span>
<span id="cb45-39"><a href="encounter.html#cb45-39"></a>rf_assessment &lt;-<span class="st"> </span><span class="kw">tibble</span>(</span>
<span id="cb45-40"><a href="encounter.html#cb45-40"></a>  <span class="dt">model =</span> <span class="kw">c</span>(<span class="st">&quot;RF&quot;</span>, <span class="st">&quot;Calibrated RF&quot;</span>),</span>
<span id="cb45-41"><a href="encounter.html#cb45-41"></a>  <span class="dt">mse =</span> <span class="kw">c</span>(mse_fit, mse_cal),</span>
<span id="cb45-42"><a href="encounter.html#cb45-42"></a>  <span class="dt">sensitivity =</span> <span class="kw">c</span>(metrics_fit<span class="op">$</span>sensitivity, metrics_cal<span class="op">$</span>sensitivity),</span>
<span id="cb45-43"><a href="encounter.html#cb45-43"></a>  <span class="dt">specificity =</span> <span class="kw">c</span>(metrics_fit<span class="op">$</span>specificity, metrics_cal<span class="op">$</span>specificity),</span>
<span id="cb45-44"><a href="encounter.html#cb45-44"></a>  <span class="dt">auc =</span> <span class="kw">c</span>(metrics_fit<span class="op">$</span>AUC, metrics_cal<span class="op">$</span>AUC),</span>
<span id="cb45-45"><a href="encounter.html#cb45-45"></a>  <span class="dt">kappa =</span> <span class="kw">c</span>(metrics_fit<span class="op">$</span>Kappa, metrics_cal<span class="op">$</span>Kappa)</span>
<span id="cb45-46"><a href="encounter.html#cb45-46"></a>)</span>
<span id="cb45-47"><a href="encounter.html#cb45-47"></a>knitr<span class="op">::</span><span class="kw">kable</span>(rf_assessment, <span class="dt">digits =</span> <span class="dv">3</span>)</span></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">model</th>
<th align="right">mse</th>
<th align="right">sensitivity</th>
<th align="right">specificity</th>
<th align="right">auc</th>
<th align="right">kappa</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">RF</td>
<td align="right">0.139</td>
<td align="right">0.358</td>
<td align="right">0.946</td>
<td align="right">0.831</td>
<td align="right">0.306</td>
</tr>
<tr class="even">
<td align="left">Calibrated RF</td>
<td align="right">0.064</td>
<td align="right">0.554</td>
<td align="right">0.882</td>
<td align="right">0.831</td>
<td align="right">0.309</td>
</tr>
</tbody>
</table>
<p>Each of these metrics can inform us about different aspects of the model fit. The objectives of your study will determine which of these metrics is most important. For example, if you want to ensure that the model definitely includes all areas of species presence, you would seek to have high sensitivity. Alternatively, if you want to ensure that places the model predicts for species occurrence are true (for example, when identifying areas for conservation action), you would seek to maximise specificity. Note that in our example, calibration had little effect on any of the metrics of accurate classification (i.e. binary presence/absence), but the mean squared error in estimation of probability of occurrence was halved by calibration.</p>
</div>
</div>
<div id="encounter-habitat" class="section level2" number="4.5">
<h2><span class="header-section-number">4.5</span> Habitat associations</h2>
<p>From the random forest model, we can glean two important sources of information about the association between Wood Thrush detection and features of their local environment. First, <strong>predictor importance</strong> is a measure of the predictive power of each covariate, and is calculated as a byproduct of fitting a random forest model. Second, <strong>partial dependence</strong> plots estimate the marginal effect of one predictor holding all other predictors constant.</p>
<div id="encounter-habitat-pi" class="section level3" number="4.5.1">
<h3><span class="header-section-number">4.5.1</span> Predictor importance</h3>
<p>During the process of fitting a random forest model, some variables are removed at each node of the trees that make up the random forest. <strong>Predictor importance</strong> is based on the mean decrease in accuracy of the model when a given covariate is not used. It’s technically an average <a href="https://en.wikipedia.org/wiki/Gini_coefficient">Gini index</a>, but essentially larger values indicate that a predictor is more important to the model.</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="encounter.html#cb46-1"></a>pi &lt;-<span class="st"> </span><span class="kw">enframe</span>(rf<span class="op">$</span>variable.importance, <span class="st">&quot;predictor&quot;</span>, <span class="st">&quot;importance&quot;</span>)</span>
<span id="cb46-2"><a href="encounter.html#cb46-2"></a><span class="co"># plot</span></span>
<span id="cb46-3"><a href="encounter.html#cb46-3"></a><span class="kw">ggplot</span>(pi) <span class="op">+</span><span class="st"> </span></span>
<span id="cb46-4"><a href="encounter.html#cb46-4"></a><span class="st">  </span><span class="kw">aes</span>(<span class="dt">x =</span> <span class="kw">fct_reorder</span>(predictor, importance), <span class="dt">y =</span> importance) <span class="op">+</span></span>
<span id="cb46-5"><a href="encounter.html#cb46-5"></a><span class="st">  </span><span class="kw">geom_col</span>() <span class="op">+</span></span>
<span id="cb46-6"><a href="encounter.html#cb46-6"></a><span class="st">  </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="dv">0</span>, <span class="dt">size =</span> <span class="dv">2</span>, <span class="dt">colour =</span> <span class="st">&quot;#555555&quot;</span>) <span class="op">+</span></span>
<span id="cb46-7"><a href="encounter.html#cb46-7"></a><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">expand =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="op">+</span></span>
<span id="cb46-8"><a href="encounter.html#cb46-8"></a><span class="st">  </span><span class="kw">coord_flip</span>() <span class="op">+</span></span>
<span id="cb46-9"><a href="encounter.html#cb46-9"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="ot">NULL</span>, </span>
<span id="cb46-10"><a href="encounter.html#cb46-10"></a>       <span class="dt">y =</span> <span class="st">&quot;Predictor Importance (Gini Index)&quot;</span>) <span class="op">+</span></span>
<span id="cb46-11"><a href="encounter.html#cb46-11"></a><span class="st">  </span><span class="kw">theme_minimal</span>() <span class="op">+</span></span>
<span id="cb46-12"><a href="encounter.html#cb46-12"></a><span class="st">  </span><span class="kw">theme</span>(<span class="dt">panel.grid =</span> <span class="kw">element_blank</span>(),</span>
<span id="cb46-13"><a href="encounter.html#cb46-13"></a>        <span class="dt">panel.grid.major.x =</span> <span class="kw">element_line</span>(<span class="dt">colour =</span> <span class="st">&quot;#cccccc&quot;</span>, <span class="dt">size =</span> <span class="fl">0.5</span>))</span></code></pre></div>
<p><img src="ebird-best-practices_files/figure-html/encounter-habitat-pi-1.png" width="\textwidth" style="display: block; margin: auto;" /></p>
<p>The most important predictors of detection/non-detection are generally effort variables. Indeed, that’s the case here: start time and checklist duration both have high predictor importance. This tells us that the time of day and length of time the observer was out, both have a large effect on whether Wood Thrush was recorded on the checklist.</p>
<p>Both elevation covariates have high importance, and the top descriptors of vegetation type are the proportions of mixed forest, woody savanna, and deciduous broadleaf forest. Note that high importance doesn’t tell us the direction of the relationship with detection, for that we’ll have to look at partial dependence plots.</p>
<p>Let’s grab the top 9 most important predictors, which we’ll need in the next section.</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="encounter.html#cb47-1"></a><span class="co"># top 9 predictors other than date</span></span>
<span id="cb47-2"><a href="encounter.html#cb47-2"></a>top_pred &lt;-<span class="st"> </span>pi <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb47-3"><a href="encounter.html#cb47-3"></a><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span>predictor <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;year&quot;</span>, <span class="st">&quot;day_of_year&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb47-4"><a href="encounter.html#cb47-4"></a><span class="st">  </span><span class="kw">top_n</span>(<span class="dt">n =</span> <span class="dv">9</span>, <span class="dt">wt =</span> importance) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb47-5"><a href="encounter.html#cb47-5"></a><span class="st">  </span><span class="kw">arrange</span>(<span class="kw">desc</span>(importance))</span></code></pre></div>
</div>
<div id="encounter-habitat-pd" class="section level3" number="4.5.2">
<h3><span class="header-section-number">4.5.2</span> Partial dependence</h3>
<p><strong>Partial dependence</strong> plots show the marginal effect of a given predictor on encounter rate averaged across the other predictors. These plots are generated by predicting encounter rate at a regular sequence of points across the full range of values of a given predictor. At each predictor value, predictions of encounter rate are made for a random subsample of the training dataset with the focal predictor fixed, but all other predictors left as is. The encounter rate predictions are then averaged across all the checklists in the training dataset giving an estimate of the average encounter rate at a specific value of the focal predictor. This is a cumbersome process, but we provide a function below that does all the hard work for you! This function takes the following arguments:</p>
<ul>
<li><code>predictor</code>: the name of the predictor to calculate partial dependence for</li>
<li><code>model</code>: the encounter rate model</li>
<li><code>data</code>: the original data used to train the model</li>
<li><code>x_res</code>: the resolution of the grid over which to calculate the partial dependence, i.e. the number of points between the minimum and maximum values of the predictor to evaluate partial dependence at</li>
<li><code>n</code>: number of points to subsample from the training data</li>
</ul>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="encounter.html#cb48-1"></a><span class="co"># function to calculate partial dependence for a single predictor</span></span>
<span id="cb48-2"><a href="encounter.html#cb48-2"></a>calculate_pd &lt;-<span class="st"> </span><span class="cf">function</span>(predictor, model, data, </span>
<span id="cb48-3"><a href="encounter.html#cb48-3"></a>                         <span class="dt">x_res =</span> <span class="dv">25</span>, <span class="dt">n =</span> <span class="dv">1000</span>) {</span>
<span id="cb48-4"><a href="encounter.html#cb48-4"></a>  <span class="co"># create prediction grid</span></span>
<span id="cb48-5"><a href="encounter.html#cb48-5"></a>  rng &lt;-<span class="st"> </span><span class="kw">range</span>(data[[predictor]], <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</span>
<span id="cb48-6"><a href="encounter.html#cb48-6"></a>  x_grid &lt;-<span class="st"> </span><span class="kw">seq</span>(rng[<span class="dv">1</span>], rng[<span class="dv">2</span>], <span class="dt">length.out =</span> x_res)</span>
<span id="cb48-7"><a href="encounter.html#cb48-7"></a>  grid &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">covariate =</span> predictor, <span class="dt">x =</span> x_grid, </span>
<span id="cb48-8"><a href="encounter.html#cb48-8"></a>                     <span class="dt">stringsAsFactors =</span> <span class="ot">FALSE</span>)</span>
<span id="cb48-9"><a href="encounter.html#cb48-9"></a>  <span class="kw">names</span>(grid) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;covariate&quot;</span>, predictor)</span>
<span id="cb48-10"><a href="encounter.html#cb48-10"></a>  </span>
<span id="cb48-11"><a href="encounter.html#cb48-11"></a>  <span class="co"># subsample training data</span></span>
<span id="cb48-12"><a href="encounter.html#cb48-12"></a>  n &lt;-<span class="st"> </span><span class="kw">min</span>(n, <span class="kw">nrow</span>(data))</span>
<span id="cb48-13"><a href="encounter.html#cb48-13"></a>  s &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="kw">seq.int</span>(<span class="kw">nrow</span>(data)), <span class="dt">size =</span> n, <span class="dt">replace =</span> <span class="ot">FALSE</span>)</span>
<span id="cb48-14"><a href="encounter.html#cb48-14"></a>  data &lt;-<span class="st"> </span>data[s, ]</span>
<span id="cb48-15"><a href="encounter.html#cb48-15"></a>  </span>
<span id="cb48-16"><a href="encounter.html#cb48-16"></a>  <span class="co"># drop focal predictor from data</span></span>
<span id="cb48-17"><a href="encounter.html#cb48-17"></a>  data &lt;-<span class="st"> </span>data[<span class="kw">names</span>(data) <span class="op">!=</span><span class="st"> </span>predictor]</span>
<span id="cb48-18"><a href="encounter.html#cb48-18"></a>  grid &lt;-<span class="st"> </span><span class="kw">merge</span>(grid, data, <span class="dt">all =</span> <span class="ot">TRUE</span>)</span>
<span id="cb48-19"><a href="encounter.html#cb48-19"></a>  </span>
<span id="cb48-20"><a href="encounter.html#cb48-20"></a>  <span class="co"># predict</span></span>
<span id="cb48-21"><a href="encounter.html#cb48-21"></a>  p &lt;-<span class="st"> </span><span class="kw">predict</span>(model, <span class="dt">data =</span> grid)</span>
<span id="cb48-22"><a href="encounter.html#cb48-22"></a>  </span>
<span id="cb48-23"><a href="encounter.html#cb48-23"></a>  <span class="co"># summarize</span></span>
<span id="cb48-24"><a href="encounter.html#cb48-24"></a>  pd &lt;-<span class="st"> </span>grid[, <span class="kw">c</span>(<span class="st">&quot;covariate&quot;</span>, predictor)]</span>
<span id="cb48-25"><a href="encounter.html#cb48-25"></a>  <span class="kw">names</span>(pd) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;covariate&quot;</span>, <span class="st">&quot;x&quot;</span>)</span>
<span id="cb48-26"><a href="encounter.html#cb48-26"></a>  pd<span class="op">$</span>pred &lt;-<span class="st"> </span>p<span class="op">$</span>predictions[, <span class="dv">2</span>]</span>
<span id="cb48-27"><a href="encounter.html#cb48-27"></a>  pd &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw">group_by</span>(pd, covariate, x) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb48-28"><a href="encounter.html#cb48-28"></a><span class="st">    </span>dplyr<span class="op">::</span><span class="kw">summarise</span>(<span class="dt">pred =</span> <span class="kw">mean</span>(pred, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb48-29"><a href="encounter.html#cb48-29"></a><span class="st">    </span>dplyr<span class="op">::</span><span class="kw">ungroup</span>()</span>
<span id="cb48-30"><a href="encounter.html#cb48-30"></a>  </span>
<span id="cb48-31"><a href="encounter.html#cb48-31"></a>  <span class="kw">return</span>(pd)</span>
<span id="cb48-32"><a href="encounter.html#cb48-32"></a>}</span></code></pre></div>
<p>Now we’ll use this function to calculate partial dependence for the top 9 predictors.</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="encounter.html#cb49-1"></a><span class="co"># calculate partial dependence for each predictor</span></span>
<span id="cb49-2"><a href="encounter.html#cb49-2"></a><span class="co"># map is used to iteratively apply calculate_pd to each predictor</span></span>
<span id="cb49-3"><a href="encounter.html#cb49-3"></a>pd &lt;-<span class="st"> </span>top_pred <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb49-4"><a href="encounter.html#cb49-4"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">pd =</span> <span class="kw">map</span>(predictor, calculate_pd, <span class="dt">model =</span> rf, </span>
<span id="cb49-5"><a href="encounter.html#cb49-5"></a>                  <span class="dt">data =</span> ebird_split<span class="op">$</span>train),</span>
<span id="cb49-6"><a href="encounter.html#cb49-6"></a>         <span class="dt">pd =</span> <span class="kw">map</span>(pd, <span class="op">~</span><span class="st"> </span>.[, <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">3</span>)]),</span>
<span id="cb49-7"><a href="encounter.html#cb49-7"></a>         <span class="dt">pd =</span> <span class="kw">map</span>(pd, set_names, <span class="dt">nm =</span> <span class="kw">c</span>(<span class="st">&quot;value&quot;</span>,  <span class="st">&quot;encounter_rate&quot;</span>))) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb49-8"><a href="encounter.html#cb49-8"></a><span class="st">  </span><span class="kw">unnest</span>(<span class="dt">cols =</span> pd)</span>
<span id="cb49-9"><a href="encounter.html#cb49-9"></a></span>
<span id="cb49-10"><a href="encounter.html#cb49-10"></a><span class="co"># calibrate predictions</span></span>
<span id="cb49-11"><a href="encounter.html#cb49-11"></a>pd<span class="op">$</span>encounter_rate &lt;-<span class="st"> </span><span class="kw">predict</span>(calibration_model, </span>
<span id="cb49-12"><a href="encounter.html#cb49-12"></a>                             <span class="dt">newdata =</span> <span class="kw">tibble</span>(<span class="dt">pred =</span> pd<span class="op">$</span>encounter_rate), </span>
<span id="cb49-13"><a href="encounter.html#cb49-13"></a>                             <span class="dt">type =</span> <span class="st">&quot;response&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb49-14"><a href="encounter.html#cb49-14"></a><span class="st">  </span><span class="kw">as.numeric</span>()</span>
<span id="cb49-15"><a href="encounter.html#cb49-15"></a>  </span>
<span id="cb49-16"><a href="encounter.html#cb49-16"></a><span class="co"># plot</span></span>
<span id="cb49-17"><a href="encounter.html#cb49-17"></a><span class="kw">ggplot</span>(pd) <span class="op">+</span></span>
<span id="cb49-18"><a href="encounter.html#cb49-18"></a><span class="st">  </span><span class="kw">aes</span>(<span class="dt">x =</span> value, <span class="dt">y =</span> encounter_rate) <span class="op">+</span></span>
<span id="cb49-19"><a href="encounter.html#cb49-19"></a><span class="st">  </span><span class="kw">geom_line</span>() <span class="op">+</span></span>
<span id="cb49-20"><a href="encounter.html#cb49-20"></a><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span></span>
<span id="cb49-21"><a href="encounter.html#cb49-21"></a><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> scales<span class="op">::</span>percent) <span class="op">+</span></span>
<span id="cb49-22"><a href="encounter.html#cb49-22"></a><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span><span class="st"> </span><span class="kw">as_factor</span>(predictor), <span class="dt">nrow =</span> <span class="dv">3</span>, <span class="dt">scales =</span> <span class="st">&quot;free&quot;</span>) <span class="op">+</span></span>
<span id="cb49-23"><a href="encounter.html#cb49-23"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="ot">NULL</span>, <span class="dt">y =</span> <span class="st">&quot;Encounter Rate&quot;</span>) <span class="op">+</span></span>
<span id="cb49-24"><a href="encounter.html#cb49-24"></a><span class="st">  </span><span class="kw">theme_minimal</span>() <span class="op">+</span></span>
<span id="cb49-25"><a href="encounter.html#cb49-25"></a><span class="st">  </span><span class="kw">theme_minimal</span>() <span class="op">+</span></span>
<span id="cb49-26"><a href="encounter.html#cb49-26"></a><span class="st">  </span><span class="kw">theme</span>(<span class="dt">panel.grid =</span> <span class="kw">element_blank</span>(),</span>
<span id="cb49-27"><a href="encounter.html#cb49-27"></a>        <span class="dt">axis.line =</span> <span class="kw">element_line</span>(<span class="dt">color =</span> <span class="st">&quot;grey60&quot;</span>),</span>
<span id="cb49-28"><a href="encounter.html#cb49-28"></a>        <span class="dt">axis.ticks  =</span> <span class="kw">element_line</span>(<span class="dt">color =</span> <span class="st">&quot;grey60&quot;</span>))</span></code></pre></div>
<p><img src="ebird-best-practices_files/figure-html/encounter-habitat-pd-1.png" width="\textwidth" style="display: block; margin: auto;" /></p>
<p>There are a range of interesting responses here. As seen in Section <a href="ebird.html#ebird-explore">2.5</a>, the encounter rate for Wood Thrush peaks early in the morning when they’re most likely to be singing, then quickly drops off in the middle of the day, before slightly increasing in the evening. Some other predictors show a more smoothly increasing relationship with encounter rate, for example, as the landscape contains more deciduous forest, the encounter rate increases.</p>
<p>The random forest model has a number of interactions, which are not displayed in these partial dependence plots. When interpreting these, bear in mind that there are likely some more complex interaction effects beneath these individual plots.</p>
</div>
</div>
<div id="encounter-predict" class="section level2" number="4.6">
<h2><span class="header-section-number">4.6</span> Prediction</h2>
<p>Now for the fun part: let’s use the calibrated random forest model to make a map of Wood Thrush encounter rate in BCR 27! In Section <a href="covariates.html#covariates-prediction">3.4</a>, we created a prediction surface consisting of the PLAND habitat covariates summarized on a regular grid of points across BCR 27. In this section, we’ll make predictions of encounter rate at these points. However, first we need to bring effort variables into this prediction surface. We’ll make predictions for a <strong>standard eBird checklist</strong>: a 1 km, 1 hour traveling count at the peak time of day for detecting this species. Finally, we’ll make these predictions for June 15, 2018, the middle of our June focal window for the latest year for which MODIS landcover data exist.</p>
<p>To find the time of day with the highest detection probability, we can look for the peak of the partial dependence plot. The one caveat to this approach is that it’s important we focus on times of day for which there are enough data to make predictions. In particular, there’s an increasing trend in detectability with earlier start times, and few checklists late at night, which can cause the model to incorrectly extrapolate that trend to show highest detectability at night. Let’s start by looking at a plot to see if this is happening here.</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="encounter.html#cb50-1"></a><span class="co"># find peak time of day from partial dependence</span></span>
<span id="cb50-2"><a href="encounter.html#cb50-2"></a>pd_time &lt;-<span class="st"> </span><span class="kw">calculate_pd</span>(<span class="st">&quot;time_observations_started&quot;</span>,</span>
<span id="cb50-3"><a href="encounter.html#cb50-3"></a>                        <span class="dt">model =</span> rf, </span>
<span id="cb50-4"><a href="encounter.html#cb50-4"></a>                        <span class="dt">data =</span> ebird_split<span class="op">$</span>train,</span>
<span id="cb50-5"><a href="encounter.html#cb50-5"></a>                        <span class="co"># make estimates at 30 minute intervals</span></span>
<span id="cb50-6"><a href="encounter.html#cb50-6"></a>                        <span class="co"># using a subset of the training dataset</span></span>
<span id="cb50-7"><a href="encounter.html#cb50-7"></a>                        <span class="dt">x_res =</span> <span class="dv">2</span> <span class="op">*</span><span class="st"> </span><span class="dv">24</span>, <span class="dt">n =</span> <span class="dv">1000</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb50-8"><a href="encounter.html#cb50-8"></a><span class="st">  </span><span class="kw">transmute</span>(<span class="dt">time_observations_started =</span> x, <span class="dt">encounter_rate =</span> pred)</span>
<span id="cb50-9"><a href="encounter.html#cb50-9"></a></span>
<span id="cb50-10"><a href="encounter.html#cb50-10"></a><span class="co"># histogram</span></span>
<span id="cb50-11"><a href="encounter.html#cb50-11"></a>g_hist &lt;-<span class="st"> </span><span class="kw">ggplot</span>(ebird_split<span class="op">$</span>train) <span class="op">+</span></span>
<span id="cb50-12"><a href="encounter.html#cb50-12"></a><span class="st">  </span><span class="kw">aes</span>(<span class="dt">x =</span> time_observations_started) <span class="op">+</span></span>
<span id="cb50-13"><a href="encounter.html#cb50-13"></a><span class="st">  </span><span class="kw">geom_histogram</span>(<span class="dt">binwidth =</span> <span class="dv">1</span>, <span class="dt">center =</span> <span class="fl">0.5</span>, <span class="dt">color =</span> <span class="st">&quot;grey30&quot;</span>,</span>
<span id="cb50-14"><a href="encounter.html#cb50-14"></a>                 <span class="dt">fill =</span> <span class="st">&quot;grey50&quot;</span>) <span class="op">+</span></span>
<span id="cb50-15"><a href="encounter.html#cb50-15"></a><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">breaks =</span> <span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">24</span>, <span class="dt">by =</span> <span class="dv">3</span>)) <span class="op">+</span></span>
<span id="cb50-16"><a href="encounter.html#cb50-16"></a><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> scales<span class="op">::</span>comma) <span class="op">+</span></span>
<span id="cb50-17"><a href="encounter.html#cb50-17"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Hours since midnight&quot;</span>,</span>
<span id="cb50-18"><a href="encounter.html#cb50-18"></a>       <span class="dt">y =</span> <span class="st">&quot;# checklists&quot;</span>,</span>
<span id="cb50-19"><a href="encounter.html#cb50-19"></a>       <span class="dt">title =</span> <span class="st">&quot;Distribution of observation start times&quot;</span>)</span>
<span id="cb50-20"><a href="encounter.html#cb50-20"></a></span>
<span id="cb50-21"><a href="encounter.html#cb50-21"></a><span class="co"># gam</span></span>
<span id="cb50-22"><a href="encounter.html#cb50-22"></a>g_pd &lt;-<span class="st"> </span><span class="kw">ggplot</span>(pd_time) <span class="op">+</span></span>
<span id="cb50-23"><a href="encounter.html#cb50-23"></a><span class="st">  </span><span class="kw">aes</span>(<span class="dt">x =</span> time_observations_started, <span class="dt">y =</span> encounter_rate) <span class="op">+</span></span>
<span id="cb50-24"><a href="encounter.html#cb50-24"></a><span class="st">  </span><span class="kw">geom_line</span>() <span class="op">+</span></span>
<span id="cb50-25"><a href="encounter.html#cb50-25"></a><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">breaks =</span> <span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">24</span>, <span class="dt">by =</span> <span class="dv">3</span>)) <span class="op">+</span></span>
<span id="cb50-26"><a href="encounter.html#cb50-26"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Hours since midnight&quot;</span>,</span>
<span id="cb50-27"><a href="encounter.html#cb50-27"></a>       <span class="dt">y =</span> <span class="st">&quot;Probability of reporting&quot;</span>,</span>
<span id="cb50-28"><a href="encounter.html#cb50-28"></a>       <span class="dt">title =</span> <span class="st">&quot;Observation start time partial dependence&quot;</span>)</span>
<span id="cb50-29"><a href="encounter.html#cb50-29"></a></span>
<span id="cb50-30"><a href="encounter.html#cb50-30"></a><span class="co"># combine</span></span>
<span id="cb50-31"><a href="encounter.html#cb50-31"></a><span class="kw">grid.arrange</span>(g_hist, g_pd)</span></code></pre></div>
<p><img src="ebird-best-practices_files/figure-html/encounter-predict-time-1.png" width="\textwidth" style="display: block; margin: auto;" /></p>
<p>The peak probability of reporting is very close to the time of day during which the abundance of reports starts to increase, but from these graphs it is not entirely clear that the early morning peak in reports is well substantiated by abundant data. Let’s instead look for the peak time within hours of the day that contain at least 1% of the training data.</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="encounter.html#cb51-1"></a><span class="co"># hours with at least 1% of checklists</span></span>
<span id="cb51-2"><a href="encounter.html#cb51-2"></a>search_hours &lt;-<span class="st"> </span>ebird_split<span class="op">$</span>train <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb51-3"><a href="encounter.html#cb51-3"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">hour =</span> <span class="kw">floor</span>(time_observations_started)) <span class="op">%&gt;%</span></span>
<span id="cb51-4"><a href="encounter.html#cb51-4"></a><span class="st">  </span><span class="kw">count</span>(hour) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb51-5"><a href="encounter.html#cb51-5"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">pct =</span> n <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(n)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb51-6"><a href="encounter.html#cb51-6"></a><span class="st">  </span><span class="kw">filter</span>(pct <span class="op">&gt;=</span><span class="st"> </span><span class="fl">0.01</span>)</span>
<span id="cb51-7"><a href="encounter.html#cb51-7"></a></span>
<span id="cb51-8"><a href="encounter.html#cb51-8"></a><span class="co"># constrained peak time</span></span>
<span id="cb51-9"><a href="encounter.html#cb51-9"></a>t_peak &lt;-<span class="st"> </span>pd_time <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb51-10"><a href="encounter.html#cb51-10"></a><span class="st">  </span><span class="kw">filter</span>(<span class="kw">floor</span>(time_observations_started) <span class="op">%in%</span><span class="st"> </span>search_hours<span class="op">$</span>hour) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb51-11"><a href="encounter.html#cb51-11"></a><span class="st">  </span><span class="kw">top_n</span>(<span class="dv">1</span>, <span class="dt">wt =</span> <span class="kw">desc</span>(time_observations_started)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb51-12"><a href="encounter.html#cb51-12"></a><span class="st">  </span><span class="kw">pull</span>(time_observations_started)</span>
<span id="cb51-13"><a href="encounter.html#cb51-13"></a>t_peak</span>
<span id="cb51-14"><a href="encounter.html#cb51-14"></a><span class="co">#&gt; [1] 5.07</span></span></code></pre></div>
<p>Based on this analysis, the best time for detecting Wood Thrush is at 5:04 AM. Now we use this time to make predictions. This is equivalent to many eBirders all conducting a checklist within different grid cells on June 15 at 5:04 AM. We also add the other effort variables to the prediction dataset.</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="encounter.html#cb52-1"></a><span class="co"># add effort covariates to prediction </span></span>
<span id="cb52-2"><a href="encounter.html#cb52-2"></a>pred_surface_eff &lt;-<span class="st"> </span>pred_surface <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb52-3"><a href="encounter.html#cb52-3"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">observation_date =</span> <span class="kw">ymd</span>(<span class="kw">str_glue</span>(<span class="st">&quot;{max_lc_year}-06-15&quot;</span>)),</span>
<span id="cb52-4"><a href="encounter.html#cb52-4"></a>         <span class="dt">year =</span> <span class="kw">year</span>(observation_date),</span>
<span id="cb52-5"><a href="encounter.html#cb52-5"></a>         <span class="dt">day_of_year =</span> <span class="kw">yday</span>(observation_date),</span>
<span id="cb52-6"><a href="encounter.html#cb52-6"></a>         <span class="dt">time_observations_started =</span> t_peak,</span>
<span id="cb52-7"><a href="encounter.html#cb52-7"></a>         <span class="dt">duration_minutes =</span> <span class="dv">60</span>,</span>
<span id="cb52-8"><a href="encounter.html#cb52-8"></a>         <span class="dt">effort_distance_km =</span> <span class="dv">1</span>,</span>
<span id="cb52-9"><a href="encounter.html#cb52-9"></a>         <span class="dt">number_observers =</span> <span class="dv">1</span>)</span>
<span id="cb52-10"><a href="encounter.html#cb52-10"></a></span>
<span id="cb52-11"><a href="encounter.html#cb52-11"></a><span class="co"># predict</span></span>
<span id="cb52-12"><a href="encounter.html#cb52-12"></a>pred_rf &lt;-<span class="st"> </span><span class="kw">predict</span>(rf, <span class="dt">data =</span> pred_surface_eff, <span class="dt">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb52-13"><a href="encounter.html#cb52-13"></a>pred_rf &lt;-<span class="st"> </span>pred_rf<span class="op">$</span>predictions[, <span class="dv">2</span>]</span>
<span id="cb52-14"><a href="encounter.html#cb52-14"></a><span class="co"># apply calibration models</span></span>
<span id="cb52-15"><a href="encounter.html#cb52-15"></a>pred_rf_cal &lt;-<span class="st"> </span><span class="kw">predict</span>(calibration_model, </span>
<span id="cb52-16"><a href="encounter.html#cb52-16"></a>                       <span class="kw">data.frame</span>(<span class="dt">pred =</span> pred_rf), </span>
<span id="cb52-17"><a href="encounter.html#cb52-17"></a>                       <span class="dt">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb52-18"><a href="encounter.html#cb52-18"></a><span class="co"># add to prediction surface</span></span>
<span id="cb52-19"><a href="encounter.html#cb52-19"></a>pred_er &lt;-<span class="st"> </span><span class="kw">bind_cols</span>(pred_surface_eff, <span class="dt">encounter_rate =</span> pred_rf_cal) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb52-20"><a href="encounter.html#cb52-20"></a><span class="st">  </span><span class="kw">select</span>(latitude, longitude, encounter_rate) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb52-21"><a href="encounter.html#cb52-21"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">encounter_rate =</span> <span class="kw">pmin</span>(<span class="kw">pmax</span>(encounter_rate, <span class="dv">0</span>), <span class="dv">1</span>))</span></code></pre></div>
<p>Next, we’ll convert this data frame to spatial features using <code>sf</code>, then rasterize the points using the prediction surface raster template.</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="encounter.html#cb53-1"></a>r_pred &lt;-<span class="st"> </span>pred_er <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb53-2"><a href="encounter.html#cb53-2"></a><span class="st">  </span><span class="co"># convert to spatial features</span></span>
<span id="cb53-3"><a href="encounter.html#cb53-3"></a><span class="st">  </span><span class="kw">st_as_sf</span>(<span class="dt">coords =</span> <span class="kw">c</span>(<span class="st">&quot;longitude&quot;</span>, <span class="st">&quot;latitude&quot;</span>), <span class="dt">crs =</span> <span class="dv">4326</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb53-4"><a href="encounter.html#cb53-4"></a><span class="st">  </span><span class="kw">st_transform</span>(<span class="dt">crs =</span> <span class="kw">projection</span>(r)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb53-5"><a href="encounter.html#cb53-5"></a><span class="st">  </span><span class="co"># rasterize</span></span>
<span id="cb53-6"><a href="encounter.html#cb53-6"></a><span class="st">  </span><span class="kw">rasterize</span>(r)</span>
<span id="cb53-7"><a href="encounter.html#cb53-7"></a>r_pred &lt;-<span class="st"> </span>r_pred[[<span class="op">-</span><span class="dv">1</span>]]</span>
<span id="cb53-8"><a href="encounter.html#cb53-8"></a></span>
<span id="cb53-9"><a href="encounter.html#cb53-9"></a><span class="co"># save the raster</span></span>
<span id="cb53-10"><a href="encounter.html#cb53-10"></a>tif_dir &lt;-<span class="st"> &quot;output&quot;</span></span>
<span id="cb53-11"><a href="encounter.html#cb53-11"></a><span class="cf">if</span> (<span class="op">!</span><span class="kw">dir.exists</span>(tif_dir)) {</span>
<span id="cb53-12"><a href="encounter.html#cb53-12"></a>  <span class="kw">dir.create</span>(tif_dir)</span>
<span id="cb53-13"><a href="encounter.html#cb53-13"></a>}</span>
<span id="cb53-14"><a href="encounter.html#cb53-14"></a><span class="kw">writeRaster</span>(r_pred, <span class="kw">file.path</span>(tif_dir, <span class="st">&quot;rf-model_encounter-rate_woothr.tif&quot;</span>), </span>
<span id="cb53-15"><a href="encounter.html#cb53-15"></a>            <span class="dt">overwrite =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<p>Finally, we can map these predictions!</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="encounter.html#cb54-1"></a><span class="co"># project predictions</span></span>
<span id="cb54-2"><a href="encounter.html#cb54-2"></a>r_pred_proj &lt;-<span class="st"> </span><span class="kw">projectRaster</span>(r_pred, <span class="dt">crs =</span> map_proj<span class="op">$</span>proj4string, <span class="dt">method =</span> <span class="st">&quot;ngb&quot;</span>)</span>
<span id="cb54-3"><a href="encounter.html#cb54-3"></a></span>
<span id="cb54-4"><a href="encounter.html#cb54-4"></a><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="fl">3.5</span>, <span class="fl">0.25</span>, <span class="fl">0.25</span>, <span class="fl">0.25</span>))</span>
<span id="cb54-5"><a href="encounter.html#cb54-5"></a><span class="co"># set up plot area</span></span>
<span id="cb54-6"><a href="encounter.html#cb54-6"></a><span class="kw">plot</span>(bcr, <span class="dt">col =</span> <span class="ot">NA</span>, <span class="dt">border =</span> <span class="ot">NA</span>)</span>
<span id="cb54-7"><a href="encounter.html#cb54-7"></a><span class="kw">plot</span>(ne_land, <span class="dt">col =</span> <span class="st">&quot;#dddddd&quot;</span>, <span class="dt">border =</span> <span class="st">&quot;#888888&quot;</span>, <span class="dt">lwd =</span> <span class="fl">0.5</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</span>
<span id="cb54-8"><a href="encounter.html#cb54-8"></a></span>
<span id="cb54-9"><a href="encounter.html#cb54-9"></a><span class="co"># encounter rate</span></span>
<span id="cb54-10"><a href="encounter.html#cb54-10"></a>r_max &lt;-<span class="st"> </span><span class="kw">ceiling</span>(<span class="dv">10</span> <span class="op">*</span><span class="st"> </span><span class="kw">cellStats</span>(r_pred_proj, max)) <span class="op">/</span><span class="st"> </span><span class="dv">10</span></span>
<span id="cb54-11"><a href="encounter.html#cb54-11"></a>brks &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">0</span>, r_max, <span class="dt">by =</span> <span class="fl">0.025</span>)</span>
<span id="cb54-12"><a href="encounter.html#cb54-12"></a>lbl_brks &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">0</span>, r_max, <span class="dt">by =</span> <span class="fl">0.1</span>)</span>
<span id="cb54-13"><a href="encounter.html#cb54-13"></a><span class="co"># ebird status and trends color palette</span></span>
<span id="cb54-14"><a href="encounter.html#cb54-14"></a>pal &lt;-<span class="st"> </span><span class="kw">abundance_palette</span>(<span class="kw">length</span>(brks) <span class="op">-</span><span class="st"> </span><span class="dv">1</span>)</span>
<span id="cb54-15"><a href="encounter.html#cb54-15"></a><span class="kw">plot</span>(r_pred_proj, </span>
<span id="cb54-16"><a href="encounter.html#cb54-16"></a>     <span class="dt">col =</span> pal, <span class="dt">breaks =</span> brks, </span>
<span id="cb54-17"><a href="encounter.html#cb54-17"></a>     <span class="dt">maxpixels =</span> <span class="kw">ncell</span>(r_pred_proj),</span>
<span id="cb54-18"><a href="encounter.html#cb54-18"></a>     <span class="dt">legend =</span> <span class="ot">FALSE</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</span>
<span id="cb54-19"><a href="encounter.html#cb54-19"></a></span>
<span id="cb54-20"><a href="encounter.html#cb54-20"></a><span class="co"># borders</span></span>
<span id="cb54-21"><a href="encounter.html#cb54-21"></a><span class="kw">plot</span>(bcr, <span class="dt">border =</span> <span class="st">&quot;#000000&quot;</span>, <span class="dt">col =</span> <span class="ot">NA</span>, <span class="dt">lwd =</span> <span class="dv">1</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</span>
<span id="cb54-22"><a href="encounter.html#cb54-22"></a><span class="kw">plot</span>(ne_state_lines, <span class="dt">col =</span> <span class="st">&quot;#ffffff&quot;</span>, <span class="dt">lwd =</span> <span class="fl">0.75</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</span>
<span id="cb54-23"><a href="encounter.html#cb54-23"></a><span class="kw">plot</span>(ne_country_lines, <span class="dt">col =</span> <span class="st">&quot;#ffffff&quot;</span>, <span class="dt">lwd =</span> <span class="fl">1.5</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</span>
<span id="cb54-24"><a href="encounter.html#cb54-24"></a><span class="kw">box</span>()</span>
<span id="cb54-25"><a href="encounter.html#cb54-25"></a></span>
<span id="cb54-26"><a href="encounter.html#cb54-26"></a><span class="co"># legend</span></span>
<span id="cb54-27"><a href="encounter.html#cb54-27"></a><span class="kw">par</span>(<span class="dt">new =</span> <span class="ot">TRUE</span>, <span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>))</span>
<span id="cb54-28"><a href="encounter.html#cb54-28"></a>title &lt;-<span class="st"> &quot;Wood Thrush Encounter Rate&quot;</span></span>
<span id="cb54-29"><a href="encounter.html#cb54-29"></a><span class="kw">image.plot</span>(<span class="dt">zlim =</span> <span class="kw">range</span>(brks), <span class="dt">legend.only =</span> <span class="ot">TRUE</span>, </span>
<span id="cb54-30"><a href="encounter.html#cb54-30"></a>           <span class="dt">col =</span> pal, <span class="dt">breaks =</span> brks,</span>
<span id="cb54-31"><a href="encounter.html#cb54-31"></a>           <span class="dt">smallplot =</span> <span class="kw">c</span>(<span class="fl">0.25</span>, <span class="fl">0.75</span>, <span class="fl">0.06</span>, <span class="fl">0.09</span>),</span>
<span id="cb54-32"><a href="encounter.html#cb54-32"></a>           <span class="dt">horizontal =</span> <span class="ot">TRUE</span>,</span>
<span id="cb54-33"><a href="encounter.html#cb54-33"></a>           <span class="dt">axis.args =</span> <span class="kw">list</span>(<span class="dt">at =</span> lbl_brks, <span class="dt">labels =</span> lbl_brks,</span>
<span id="cb54-34"><a href="encounter.html#cb54-34"></a>                            <span class="dt">fg =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">col.axis =</span> <span class="st">&quot;black&quot;</span>,</span>
<span id="cb54-35"><a href="encounter.html#cb54-35"></a>                            <span class="dt">cex.axis =</span> <span class="fl">0.75</span>, <span class="dt">lwd.ticks =</span> <span class="fl">0.5</span>,</span>
<span id="cb54-36"><a href="encounter.html#cb54-36"></a>                            <span class="dt">padj =</span> <span class="fl">-1.5</span>),</span>
<span id="cb54-37"><a href="encounter.html#cb54-37"></a>           <span class="dt">legend.args =</span> <span class="kw">list</span>(<span class="dt">text =</span> title,</span>
<span id="cb54-38"><a href="encounter.html#cb54-38"></a>                              <span class="dt">side =</span> <span class="dv">3</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>,</span>
<span id="cb54-39"><a href="encounter.html#cb54-39"></a>                              <span class="dt">cex =</span> <span class="dv">1</span>, <span class="dt">line =</span> <span class="dv">0</span>))</span></code></pre></div>
<p><img src="ebird-best-practices_files/figure-html/encounter-predict-map-1.png" width="\textwidth" style="display: block; margin: auto;" /></p>

</div>
</div>
<h3>References</h3>
<div id="refs" class="references">
<div id="ref-chen2004using">
<p>Chen, Chao, Andy Liaw, and Leo Breiman. 2004. “Using Random Forest to Learn Imbalanced Data.” <em>University of California, Berkeley</em> 110 (1-12): 24.</p>
</div>
<div id="ref-guillera-arroitaMySpeciesDistribution2015">
<p>Guillera-Arroita, Gurutzeta, José J. Lahoz-Monfort, Jane Elith, Ascelin Gordon, Heini Kujala, Pia E. Lentini, Michael A. McCarthy, Reid Tingley, and Brendan A. Wintle. 2015. “Is My Species Distribution Model Fit for Purpose? Matching Data and Models to Applications.” <em>Global Ecology and Biogeography</em> 24 (3): 276–92.</p>
</div>
<div id="ref-murphyNewVectorPartition1973">
<p>Murphy, Allan H. 1973. “A New Vector Partition of the Probability Score.” <em>Journal of Applied Meteorology</em> 12 (4): 595–600. <a href="https://doi.org/10.1175/1520-0450(1973)012%3C0595:ANVPOT%3E2.0.CO;2">https://doi.org/10.1175/1520-0450(1973)012&lt;0595:ANVPOT&gt;2.0.CO;2</a>.</p>
</div>
<div id="ref-niculescu-mizilPredictingGoodProbabilities2005">
<p>Niculescu-Mizil, Alexandru, and Rich Caruana. 2005. “Predicting Good Probabilities with Supervised Learning.” In <em>Proceedings of the 22nd International Conference on Machine Learning</em>, 625–32. ACM.</p>
</div>
<div id="ref-plattProbabilisticOutputsSupport1999">
<p>Platt, John. 1999. “Probabilistic Outputs for Support Vector Machines and Comparisons to Regularized Likelihood Methods.” <em>Advances in Large Margin Classifiers</em> 10 (3): 61–74.</p>
</div>
<div id="ref-robinsonCorrectingBiasDistribution2018">
<p>Robinson, Orin J., Viviana Ruiz‐Gutierrez, and Daniel Fink. 2018. “Correcting for Bias in Distribution Modelling for Rare Species Using Citizen Science Data.” <em>Diversity and Distributions</em> 24 (4): 460–72. <a href="https://doi.org/10.1111/ddi.12698">https://doi.org/10.1111/ddi.12698</a>.</p>
</div>
<div id="ref-sahrHexagonalDiscreteGlobal2011">
<p>Sahr, Kevin. 2011. “Hexagonal Discrete Global Grid Systems for Geospatial Computing.” <em>Archiwum Fotogrametrii, Kartografii I Teledetekcji</em> 22: 363–76.</p>
</div>
<div id="ref-vaughanContinuingChallengesTesting2005">
<p>Vaughan, I. P., and S. J. Ormerod. 2005. “The Continuing Challenges of Testing Species Distribution Models.” <em>Journal of Applied Ecology</em> 42 (4): 720–30. <a href="https://doi.org/10.1111/j.1365-2664.2005.01052.x">https://doi.org/10.1111/j.1365-2664.2005.01052.x</a>.</p>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="covariates.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="occupancy.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": false,
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/cornelllabofornithology/ebird-best-practices/edit/master/04_encounter.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "section"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
